<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnwaltsAI Dashboard - Professional Legal AI Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'IBM Plex Sans', 'Inter', sans-serif; }
        .serif-text { font-family: 'Source Serif Pro', serif; }
        
        body {
            background: #12101c;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(46, 42, 77, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(134, 97, 247, 0.06) 0%, transparent 50%),
                linear-gradient(135deg, #12101c 0%, #1a1830 50%, #0f0d1a 100%);
        }
        
        .glass-morphism {
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.25), rgba(24, 22, 45, 0.15));
            backdrop-filter: blur(25px);
            border: 1px solid rgba(134, 97, 247, 0.3);
            box-shadow: 0 25px 50px rgba(46, 42, 77, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }
        
        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.75rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        /* Navigation Styles */
        .nav-sidebar {
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.25), rgba(24, 22, 45, 0.20));
            backdrop-filter: blur(25px);
            border-right: 1px solid rgba(134, 97, 247, 0.3);
            transition: transform 0.3s ease;
        }
        
        .nav-item {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .nav-item:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(67, 56, 202, 0.15));
            transform: translateX(2px);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.4), rgba(67, 56, 202, 0.25));
            border-right: 3px solid #8b5cf6;
        }
        
        /* Section Management */
        .section-content {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .section-content.active {
            display: block;
            opacity: 1;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .nav-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 60;
                transform: translateX(-100%);
            }
            
            .nav-sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0 !important;
            }
        }
        
        /* Header */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.15), rgba(24, 22, 45, 0.10));
            backdrop-filter: blur(25px);
            border-bottom: 1px solid rgba(134, 97, 247, 0.2);
        }
        
        /* Enhanced Card Animations */
        .feature-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0) scale(1);
        }
        
        .feature-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 25px 50px rgba(46, 42, 77, 0.4),
                0 10px 30px rgba(134, 97, 247, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }
        
        .feature-card:hover .feature-icon {
            transform: scale(1.1) rotate(5deg);
        }
        
        .feature-icon {
            transition: transform 0.3s ease;
        }
        
        /* Count-up Animation */
        .stat-number {
            font-variant-numeric: tabular-nums;
            font-weight: 700;
        }
        
        /* Pulse Animation for Feedback */
        @keyframes successPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        @keyframes rejectShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }
        
        .success-pulse {
            animation: successPulse 0.6s ease-out;
        }
        
        .reject-shake {
            animation: rejectShake 0.5s ease-in-out;
        }
        
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8661f7, #6d44d3);
            box-shadow: 0 8px 24px rgba(134, 97, 247, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 90;
            user-select: none;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 32px rgba(134, 97, 247, 0.6);
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        .fab-menu {
            position: fixed;
            bottom: 5rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 89;
            opacity: 0;
            transform: translateY(20px) scale(0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }
        
        .fab-menu.open {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: all;
        }
        
        .fab-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.95), rgba(24, 22, 45, 0.9));
            border: 1px solid rgba(134, 97, 247, 0.3);
            border-radius: 0.75rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(20px);
            white-space: nowrap;
            min-width: 140px;
        }
        
        .fab-item:hover {
            background: linear-gradient(135deg, rgba(134, 97, 247, 0.3), rgba(46, 42, 77, 0.9));
            transform: translateX(-8px);
            border-color: rgba(134, 97, 247, 0.5);
        }
        
        .fab-item:active {
            transform: translateX(-4px) scale(0.98);
        }
        
        /* Responsive FAB Design */
        @media (max-width: 768px) {
            .fab {
                bottom: 1.5rem;
                right: 1.5rem;
                width: 52px;
                height: 52px;
            }
            
            .fab-menu {
                bottom: 4.5rem;
                right: 1.5rem;
            }
            
            .fab-item {
                padding: 0.625rem 0.875rem;
                gap: 0.75rem;
                min-width: 120px;
            }
            
            .fab-item span {
                font-size: 0.875rem;
            }
        }
        
        @media (max-width: 480px) {
            .fab {
                bottom: 1rem;
                right: 1rem;
                width: 48px;
                height: 48px;
            }
            
            .fab-menu {
                bottom: 4rem;
                right: 1rem;
            }
            
            .fab-item {
                padding: 0.5rem 0.75rem;
                gap: 0.5rem;
                min-width: 100px;
            }
            
            .fab-item span {
                font-size: 0.8rem;
            }
        }
        
        /* AI Suggestions Panel */
        .ai-suggestions {
            position: fixed;
            top: 50%;
            right: -300px;
            transform: translateY(-50%);
            width: 280px;
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.25), rgba(24, 22, 45, 0.15));
            backdrop-filter: blur(25px);
            border: 1px solid rgba(134, 97, 247, 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 30;
        }
        
        .ai-suggestions.open {
            right: 1rem;
        }
        
        /* Legal Clipboard Widget */
        .legal-clipboard {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            width: 280px;
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.25), rgba(24, 22, 45, 0.15));
            backdrop-filter: blur(25px);
            border: 1px solid rgba(134, 97, 247, 0.3);
            border-radius: 1rem;
            padding: 1rem;
            transform: translateY(calc(100% - 60px));
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 30;
            cursor: pointer;
        }
        
        .legal-clipboard:hover {
            transform: translateY(0);
        }
        
        /* Progress Timeline */
        .progress-timeline {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            opacity: 0.4;
            transition: all 0.3s ease;
        }
        
        .progress-step.active {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .progress-step.completed {
            opacity: 1;
            color: #22c55e;
        }
        
        .progress-line {
            height: 2px;
            background: rgba(134, 97, 247, 0.3);
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .progress-line::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, #22c55e, transparent);
            animation: progressFlow 2s ease-in-out infinite;
        }
        
        @keyframes progressFlow {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* Email Portal Enhancements */
        .email-list-table {
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.25), rgba(24, 22, 45, 0.15));
            backdrop-filter: blur(25px);
            border: 1px solid rgba(134, 97, 247, 0.3);
            border-radius: 1rem;
        }
        
        .email-row {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        
        .email-row:hover {
            background: linear-gradient(135deg, rgba(134, 97, 247, 0.1), rgba(46, 42, 77, 0.1));
            border-left: 4px solid #8661f7;
            transform: translateX(4px);
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .email-preview-pane {
            position: fixed;
            top: 0;
            right: -500px;
            height: 100vh;
            width: 500px;
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.95), rgba(24, 22, 45, 0.95));
            backdrop-filter: blur(25px);
            border-left: 1px solid rgba(134, 97, 247, 0.3);
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 60;
            overflow-y: auto;
        }
        
        .email-preview-pane.open {
            right: 0;
        }
        
        .legal-term {
            background: linear-gradient(135deg, rgba(134, 97, 247, 0.2), rgba(46, 42, 77, 0.2));
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid rgba(134, 97, 247, 0.4);
            color: #8661f7;
            font-weight: 500;
        }
        
        .skeleton-loader {
            background: linear-gradient(90deg, rgba(134, 97, 247, 0.1) 25%, rgba(134, 97, 247, 0.2) 50%, rgba(134, 97, 247, 0.1) 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
            border-radius: 4px;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .attachment-slider {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding: 1rem 0;
            scroll-snap-type: x mandatory;
        }
        
        .attachment-item {
            min-width: 120px;
            height: 80px;
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.3), rgba(24, 22, 45, 0.2));
            border: 1px solid rgba(134, 97, 247, 0.3);
            border-radius: 0.5rem;
            scroll-snap-align: start;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .attachment-item:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(134, 97, 247, 0.3);
        }
        
        .attachment-icon {
            transition: transform 0.3s ease;
        }
        
        .attachment-item:hover .attachment-icon {
            animation: wiggle 0.5s ease-in-out;
        }
        
        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        
        .thread-timeline {
            position: relative;
            padding-left: 2rem;
        }
        
        .thread-timeline::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #8661f7, rgba(134, 97, 247, 0.3));
        }
        
        .thread-item {
            position: relative;
            margin-bottom: 2rem;
            opacity: 0;
            animation: threadFadeIn 0.6s ease-out forwards;
        }
        
        .thread-item::before {
            content: '';
            position: absolute;
            left: -1.75rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid;
        }
        
        .thread-item.user::before { background: #3b82f6; border-color: #3b82f6; }
        .thread-item.ai::before { background: #8b5cf6; border-color: #8b5cf6; }
        .thread-item.client::before { background: #9ca3af; border-color: #9ca3af; }
        
        @keyframes threadFadeIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .email-metrics-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.25), rgba(24, 22, 45, 0.15));
            backdrop-filter: blur(25px);
            border: 1px solid rgba(134, 97, 247, 0.3);
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(134, 97, 247, 0.2);
        }
        
        .convert-cta {
            background: linear-gradient(135deg, #8661f7, #6d44d3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .convert-cta:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(134, 97, 247, 0.4);
        }
        
        .convert-cta.converting {
            animation: shrinkAndMove 0.8s ease-in-out forwards;
        }
        
        @keyframes shrinkAndMove {
            0% { transform: scale(1); }
            50% { transform: scale(0.8); }
            100% { transform: scale(0) translateX(200px); }
        }
        
        .ai-suggest-btn {
            position: relative;
            overflow: hidden;
        }
        
        .ai-suggest-btn.processing::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: processing 1.5s infinite;
        }
        
        @keyframes processing {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, rgba(134, 97, 247, 0.2), rgba(46, 42, 77, 0.2));
            border: 1px solid rgba(134, 97, 247, 0.3);
            border-radius: 9999px;
            color: #8661f7;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-tag:hover {
            background: linear-gradient(135deg, rgba(134, 97, 247, 0.3), rgba(46, 42, 77, 0.3));
            transform: translateY(-2px);
        }
        
        .filter-tag.active {
            background: linear-gradient(135deg, #8661f7, #6d44d3);
            color: white;
        }
        
        .urgency-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .urgency-high { background: #ef4444; animation: pulse 2s infinite; }
        .urgency-medium { background: #f59e0b; }
        .urgency-low { background: #10b981; }
        
        /* Glassmorphic Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .glassmorphic-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(134, 97, 247, 0.3);
            border-radius: 1rem;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            z-index: 101;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            visibility: hidden;
        }
        
        .glassmorphic-modal.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            visibility: visible;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(134, 97, 247, 0.2);
            display: flex;
            align-items: center;
            justify-content: between;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
        }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(90vh - 120px);
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 2.5rem;
            height: 2.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #9ca3af;
        }
        
        .modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
            color: #ef4444;
            transform: scale(1.1);
        }
        
        /* Enhanced Email Preview Modal */
        .email-modal {
            width: min(600px, 90vw);
            height: min(700px, 90vh);
            max-height: 90vh;
        }
        
        .email-modal .modal-body {
            padding: 0;
            display: flex;
            flex-direction: column;
            max-height: calc(90vh - 4rem);
        }
        
        .email-metadata {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(134, 97, 247, 0.2);
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.3), rgba(24, 22, 45, 0.2));
            flex-shrink: 0;
        }
        
        .email-content-panel {
            padding: 1.5rem;
            flex: 1;
            overflow-y: auto;
            min-height: 0; /* Important for flex child to be scrollable */
            max-height: 50vh;
            scrollbar-width: thin;
            scrollbar-color: rgba(134, 97, 247, 0.3) transparent;
        }
        
        .email-content-panel::-webkit-scrollbar {
            width: 6px;
        }
        
        .email-content-panel::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .email-content-panel::-webkit-scrollbar-thumb {
            background: rgba(134, 97, 247, 0.3);
            border-radius: 3px;
        }
        
        .email-content-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(134, 97, 247, 0.5);
        }
        
        .email-actions {
            padding: 1.5rem;
            border-top: 1px solid rgba(134, 97, 247, 0.2);
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.2), rgba(24, 22, 45, 0.1));
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        
        /* Responsive email modal */
        @media (max-width: 768px) {
            .email-modal {
                width: 95vw;
                height: 95vh;
            }
            
            .email-actions {
                flex-direction: column;
            }
            
            .action-btn {
                min-width: unset;
            }
        }
        
        .action-btn {
            flex: 1;
            min-width: 140px;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .action-btn.primary {
            background: linear-gradient(135deg, #8f7cfb, #7c3aed);
            color: white;
        }
        
        .action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(143, 124, 251, 0.4);
        }
        
        .action-btn.secondary {
            background: linear-gradient(135deg, #4478ff, #3b82f6);
            color: white;
        }
        
        .action-btn.secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(68, 120, 255, 0.4);
        }
        
        .action-btn.danger {
            background: linear-gradient(135deg, #f04444, #ef4444);
            color: white;
        }
        
        .action-btn.danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(240, 68, 68, 0.4);
        }
        
        /* Template Filter Modal */
        .filter-modal {
            width: min(500px, 90vw);
            height: min(600px, 90vh);
            max-height: 90vh;
        }
        
        /* Responsive filter modal */
        @media (max-width: 768px) {
            .filter-modal {
                width: 95vw;
                height: 95vh;
            }
            
            .filter-options {
                gap: 0.375rem;
            }
            
            .filter-option {
                font-size: 0.8125rem;
                padding: 0.375rem 0.75rem;
            }
        }
        
        .filter-section {
            margin-bottom: 1.5rem;
        }
        
        .filter-section h4 {
            color: white;
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }
        
        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .filter-option {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(134, 97, 247, 0.3);
            border-radius: 9999px;
            color: #d1d5db;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-option:hover {
            background: rgba(134, 97, 247, 0.1);
            border-color: rgba(134, 97, 247, 0.5);
            color: #8f7cfb;
        }
        
        .filter-option.active {
            background: linear-gradient(135deg, #8f7cfb, #7c3aed);
            border-color: #8f7cfb;
            color: white;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(134, 97, 247, 0.3);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.875rem;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            border-color: #8f7cfb;
            box-shadow: 0 0 0 3px rgba(143, 124, 251, 0.1);
        }
        
        .search-input::placeholder {
            color: #9ca3af;
        }
        
        /* Enhanced animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translate(-50%, -60%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        @keyframes fadeOutUp {
            from {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -40%) scale(0.9);
            }
        }
        
        .modal-enter {
            animation: fadeInDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal-exit {
            animation: fadeOutUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Template Card Enhancements */
        .template-card {
            animation-delay: var(--animation-delay, 0s);
        }
        
        .template-card:hover .template-border-glow {
            opacity: 1;
        }
        
        .template-border-glow {
            position: absolute;
            top: 0;
            left: -2px;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, #b8b8ff, #8f7cfb);
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .success-rate-badge {
            position: relative;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            white-space: nowrap;
            font-size: 0.75rem;
            line-height: 1;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
            text-overflow: ellipsis;
            overflow: hidden;
            max-width: 130px;
            min-width: fit-content;
            flex-shrink: 0;
            word-break: keep-all;
        }
        
        .success-rate-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 50;
            margin-bottom: 0.5rem;
        }
        
        .success-rate-badge:hover .success-rate-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        .mini-chart {
            width: 60px;
            height: 20px;
            display: inline-block;
            margin-top: 0.25rem;
        }
        
        .chart-bar-mini {
            display: inline-block;
            width: 2px;
            margin-right: 1px;
            background: linear-gradient(to top, #4ade80, #22c55e);
            border-radius: 1px;
            transform-origin: bottom;
            transition: transform 0.3s ease;
        }
        
        /* Template Section Enhancements */
        .template-card-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            padding: 1rem 0;
            align-items: start;
        }
        
        /* Mobile (default): 1 column */
        @media (min-width: 480px) {
            .template-card-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                max-width: 100%;
            }
        }
        
        /* Tablet: 2 columns */
        @media (min-width: 768px) {
            .template-card-grid {
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                gap: 2rem;
            }
        }
        
        /* Desktop: Maximum 3 columns */
        @media (min-width: 1200px) {
            .template-card-grid {
                grid-template-columns: repeat(3, 1fr);
                max-width: 1200px;
                margin: 0 auto;
                gap: 1.5rem;
            }
        }
        
        /* Large Desktop: Maintain 3-column limit */
        @media (min-width: 1400px) {
            .template-card-grid {
                grid-template-columns: repeat(3, 1fr);
                max-width: 1400px;
                gap: 2rem;
            }
        }
        
        .template-card {
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.25), rgba(24, 22, 45, 0.15));
            backdrop-filter: blur(25px);
            border: 1px solid rgba(134, 97, 247, 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            animation: templateCardFadeIn 0.6s ease-out forwards;
            display: flex;
            flex-direction: column;
            min-height: 320px;
            height: 100%;
            align-items: stretch;
        }
        
        .template-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 25px 50px rgba(134, 97, 247, 0.4),
                0 0 0 1px rgba(134, 97, 247, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .template-card:hover::before {
            opacity: 1;
        }
        
        .template-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(134, 97, 247, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        @keyframes templateCardFadeIn {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .template-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .template-tag.system {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .template-tag.custom {
            background: linear-gradient(135deg, rgba(134, 97, 247, 0.2), rgba(134, 97, 247, 0.1));
            color: #8661f7;
            border: 1px solid rgba(134, 97, 247, 0.3);
        }
        
        .template-tag.draft {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.2), rgba(251, 146, 60, 0.1));
            color: #fb923c;
            border: 1px solid rgba(251, 146, 60, 0.3);
        }
        
        /* Template Card Content Structure */
        .template-card .template-header {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .template-card .template-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #f1f5f9;
            line-height: 1.3;
            margin: 0;
            min-height: 1.5rem;
        }
        
        .template-card .template-description {
            color: #94a3b8;
            font-size: 0.875rem;
            line-height: 1.5;
            margin: 0;
            flex-grow: 1;
            min-height: 2.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .template-card .template-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid rgba(134, 97, 247, 0.2);
        }
        
        .template-card .template-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        /* Responsive adjustments for template cards */
        @media (max-width: 767px) {
            .template-card {
                min-height: 280px;
                padding: 1.25rem;
            }
            
            .template-card .template-title {
                font-size: 1rem;
            }
            
            .template-card .template-description {
                font-size: 0.8125rem;
                -webkit-line-clamp: 2;
                min-height: 2rem;
            }
            
            .success-rate-badge {
                max-width: 100px;
                font-size: 0.6875rem;
            }
        }
        
        @media (min-width: 768px) and (max-width: 1199px) {
            .template-card {
                min-height: 320px;
            }
        }
        
        @media (min-width: 1200px) {
            .template-card {
                min-height: 320px;
            }
            
            .template-card .template-title {
                font-size: 1.25rem;
            }
        }
        
        /* Additional responsive breakpoints for better UX */
        @media (min-width: 480px) and (max-width: 767px) {
            .template-card-grid {
                gap: 1.25rem;
            }
            
            .template-card {
                min-height: 280px;
            }
        }
        
        /* Large tablet landscape */
        @media (min-width: 1024px) and (max-width: 1199px) {
            .template-card-grid {
                grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
                gap: 1.75rem;
                max-width: 1100px;
                margin: 0 auto;
            }
            
            .template-card {
                min-height: 320px;
            }
        }
        
        /* Ultra-wide screens */
        @media (min-width: 1600px) {
            .template-card-grid {
                max-width: 1500px;
                gap: 2.5rem;
            }
            
            .template-card {
                min-height: 350px;
                padding: 2rem;
            }
            
            .template-card .template-title {
                font-size: 1.375rem;
            }
            
            .template-card .template-description {
                font-size: 0.9375rem;
            }
        }
        
        /* Additional improved responsive breakpoints */
        @media (min-width: 375px) and (max-width: 479px) {
            .template-card-grid {
                gap: 1rem;
                padding: 0.5rem 0;
            }
            
            .template-card {
                min-height: 260px;
                padding: 1rem;
            }
            
            .template-card .template-title {
                font-size: 0.95rem;
            }
            
            .success-rate-badge {
                font-size: 0.65rem;
                padding: 0.25rem 0.5rem;
                max-width: 90px;
            }
        }
        
        /* Medium tablet portrait */
        @media (min-width: 768px) and (max-width: 1023px) {
            .template-card-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.5rem;
                max-width: 800px;
                margin: 0 auto;
            }
            
            .template-card {
                min-height: 300px;
            }
        }
        
        /* Large desktop optimization */
        @media (min-width: 1400px) and (max-width: 1599px) {
            .template-card-grid {
                gap: 2.25rem;
            }
            
            .template-card {
                min-height: 330px;
                padding: 1.75rem;
            }
        }
        
        .suggested-templates-bar {
            background: linear-gradient(135deg, rgba(94, 234, 212, 0.1), rgba(94, 234, 212, 0.05));
            border: 1px solid rgba(94, 234, 212, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            transform: translateX(100%);
            animation: slideInFromRight 0.8s ease-out forwards;
        }
        
        @keyframes slideInFromRight {
            to {
                transform: translateX(0);
            }
        }
        
        .template-filter-sidebar {
            position: fixed;
            top: 0;
            left: -350px;
            width: 350px;
            height: 100vh;
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.95), rgba(24, 22, 45, 0.95));
            backdrop-filter: blur(25px);
            border-right: 1px solid rgba(134, 97, 247, 0.3);
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 70;
            overflow-y: auto;
        }
        
        .template-filter-sidebar.open {
            left: 0;
        }
        
        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, rgba(134, 97, 247, 0.2), rgba(46, 42, 77, 0.2));
            border: 1px solid rgba(134, 97, 247, 0.3);
            border-radius: 9999px;
            color: #8661f7;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            transform: scale(0);
            animation: springIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }
        
        .filter-chip:hover {
            background: linear-gradient(135deg, rgba(134, 97, 247, 0.3), rgba(46, 42, 77, 0.3));
            transform: scale(1.05);
        }
        
        .filter-chip.active {
            background: linear-gradient(135deg, #8661f7, #6d44d3);
            color: white;
        }
        
        @keyframes springIn {
            to {
                transform: scale(1);
            }
        }
        
        .template-diff-editor {
            font-family: 'Source Code Pro', monospace;
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.25), rgba(24, 22, 45, 0.15));
            border: 1px solid rgba(134, 97, 247, 0.3);
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
        
        .diff-line {
            padding: 0.25rem 0.5rem;
            margin: 0.125rem 0;
            border-radius: 0.25rem;
            opacity: 0;
            animation: diffLineReveal 0.3s ease-out forwards;
        }
        
        .diff-line.added {
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid #22c55e;
            color: #86efac;
        }
        
        .diff-line.removed {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            color: #fca5a5;
            text-decoration: line-through;
        }
        
        @keyframes diffLineReveal {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .template-usage-analytics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .analytics-card {
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.25), rgba(24, 22, 45, 0.15));
            backdrop-filter: blur(25px);
            border: 1px solid rgba(134, 97, 247, 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .analytics-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(134, 97, 247, 0.2);
        }
        
        .chart-container {
            height: 200px;
            display: flex;
            align-items: end;
            justify-content: space-between;
            padding: 1rem 0;
        }
        
        .chart-bar {
            background: linear-gradient(to top, #8661f7, #5eead4);
            border-radius: 0.25rem 0.25rem 0 0;
            min-width: 30px;
            transition: all 0.3s ease;
            transform: scaleY(0);
            transform-origin: bottom;
            animation: barGrowUp 1s ease-out forwards;
        }
        
        .chart-bar:hover {
            opacity: 0.8;
            transform: scaleY(1) scaleX(1.1);
        }
        
        @keyframes barGrowUp {
            to {
                transform: scaleY(1);
            }
        }
        
        
        .import-export-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 80;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .import-export-modal.open {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: linear-gradient(135deg, rgba(46, 42, 77, 0.95), rgba(24, 22, 45, 0.95));
            backdrop-filter: blur(25px);
            border: 1px solid rgba(134, 97, 247, 0.3);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .import-export-modal.open .modal-content {
            transform: scale(1);
        }
        
        .drop-zone {
            border: 2px dashed rgba(134, 97, 247, 0.5);
            border-radius: 0.75rem;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .drop-zone:hover,
        .drop-zone.drag-over {
            border-color: #8661f7;
            background: rgba(134, 97, 247, 0.1);
        }
        
        .drop-zone.drag-over .drop-icon {
            animation: dropBounce 0.6s ease-in-out infinite alternate;
        }
        
        @keyframes dropBounce {
            from { transform: translateY(0); }
            to { transform: translateY(-8px); }
        }
        
        .progress-bar {
            height: 4px;
            background: rgba(134, 97, 247, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 1rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8661f7, #5eead4);
            border-radius: 2px;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .clause-library {
            background: linear-gradient(135deg, rgba(94, 234, 212, 0.1), rgba(94, 234, 212, 0.05));
            border: 1px solid rgba(94, 234, 212, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .clause-item {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .clause-item:hover {
            background: rgba(134, 97, 247, 0.1);
            transform: translateX(4px);
        }
        
        .version-timeline {
            position: relative;
            padding-left: 2rem;
        }
        
        .version-timeline::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #8661f7, rgba(134, 97, 247, 0.3));
        }
        
        .version-item {
            position: relative;
            margin-bottom: 1.5rem;
            opacity: 0;
            animation: versionFadeIn 0.4s ease-out forwards;
        }
        
        .version-item::before {
            content: '';
            position: absolute;
            left: -1.75rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            background: #8661f7;
            border: 2px solid #8661f7;
            border-radius: 50%;
        }
        
        @keyframes versionFadeIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="text-white antialiased">
    <!-- Top Navigation -->
    <nav class="navbar">
        <div class="max-w-full mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <!-- Mobile Menu Button -->
                    <button class="lg:hidden glass-card p-2 rounded-lg hover:bg-white/10" id="mobile-menu-btn">
                        <i data-lucide="menu" class="w-5 h-5"></i>
                    </button>
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2L2 7v10c0 5.55 3.84 9.95 9 11 5.16-1.05 9-5.45 9-11V7l-10-5z"/>
                            </svg>
                        </div>
                        <h1 class="text-xl font-bold text-white">AnwaltsAI</h1>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <button class="glass-card p-2 rounded-lg hover:bg-white/10">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                    </button>
                    <button class="glass-card p-2 rounded-lg hover:bg-white/10">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-600 rounded-full flex items-center justify-center text-sm font-bold">
                            AV
                        </div>
                        <div class="hidden md:block">
                            <p class="text-sm font-medium text-white">Dr. Anna Vogel</p>
                            <p class="text-xs text-gray-400">Admin</p>
                        </div>
                        <button class="ml-2 px-3 py-2 bg-gradient-to-r from-red-500 to-red-600 rounded-lg text-white text-sm font-medium hover:from-red-600 hover:to-red-700 transition-all duration-200 flex items-center gap-2" id="signout-btn">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">Sign Out</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex pt-20 min-h-screen">
        <!-- Mobile Backdrop -->
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 lg:hidden hidden" id="mobile-backdrop"></div>
        
        <!-- Sidebar -->
        <div class="nav-sidebar w-64 flex-shrink-0 lg:relative fixed" id="sidebar">
            <div class="p-6 h-full overflow-y-auto">
                <nav class="space-y-2">
                    <div class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg" data-section="dashboard">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg" data-section="generator">
                        <i data-lucide="file-plus" class="w-5 h-5"></i>
                        <span>Document Generator</span>
                    </div>
                    <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg" data-section="emails">
                        <i data-lucide="mail" class="w-5 h-5"></i>
                        <span>E-Mails</span>
                    </div>
                    <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg" data-section="templates">
                        <i data-lucide="bookmark" class="w-5 h-5"></i>
                        <span>Templates</span>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 main-content lg:ml-0 ml-0">
            <div class="p-6 h-full overflow-y-auto">
                <!-- Dashboard Section -->
                <div class="section-content active" id="dashboard-section">
                    <div class="glass-morphism p-6 mb-6">
                        <h2 class="text-2xl font-bold text-white mb-2">Dashboard</h2>
                        <p class="text-gray-400">Übersicht Ihrer Aktivitäten</p>
                    </div>
                    
                    <!-- Stats Cards with Count-up Animation -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="glass-card p-6 feature-card" data-testid="dashboard-metric-documents">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm serif-text">Documents created</p>
                                    <p class="text-2xl font-bold text-white stat-number" data-target="42" data-testid="metric-value-documents">0</p>
                                </div>
                                <i data-lucide="file-text" class="w-8 h-8 text-blue-400 feature-icon"></i>
                            </div>
                            <div class="mt-3 text-xs text-green-400" data-testid="metric-trend-documents">
                                +12% from last month
                            </div>
                        </div>
                        <div class="glass-card p-6 feature-card" data-testid="dashboard-metric-emails">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm serif-text">Emails processed</p>
                                    <p class="text-2xl font-bold text-white stat-number" data-target="156" data-testid="metric-value-emails">0</p>
                                </div>
                                <i data-lucide="mail" class="w-8 h-8 text-purple-400 feature-icon"></i>
                            </div>
                            <div class="mt-3 text-xs text-green-400" data-testid="metric-trend-emails">
                                +8% from last week
                            </div>
                        </div>
                        <div class="glass-card p-6 feature-card" data-testid="dashboard-metric-templates">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm serif-text">Templates saved</p>
                                    <p class="text-2xl font-bold text-white stat-number" data-target="23" data-testid="metric-value-templates">0</p>
                                </div>
                                <i data-lucide="bookmark" class="w-8 h-8 text-green-400 feature-icon"></i>
                            </div>
                            <div class="mt-3 text-xs text-green-400" data-testid="metric-trend-templates">
                                +3 new templates
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Feature Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="glass-card p-6 cursor-pointer feature-card hover:scale-[1.02] transition-all duration-300" 
                             onclick="switchSection('generator')" 
                             data-testid="dashboard-action-generator">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center feature-icon">
                                    <i data-lucide="file-plus" class="w-6 h-6 text-white"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-white">Document Generator</h3>
                            </div>
                            <p class="text-gray-400 text-sm serif-text">Create legal documents with AI assistance</p>
                            <div class="progress-timeline mt-4 mb-4">
                                <div class="progress-step completed">
                                    <i data-lucide="upload" class="w-4 h-4"></i>
                                    <span class="text-xs">Upload</span>
                                </div>
                                <div class="progress-line"></div>
                                <div class="progress-step active">
                                    <i data-lucide="brain" class="w-4 h-4"></i>
                                    <span class="text-xs">AI Process</span>
                                </div>
                                <div class="progress-line"></div>
                                <div class="progress-step">
                                    <i data-lucide="check" class="w-4 h-4"></i>
                                    <span class="text-xs">Complete</span>
                                </div>
                            </div>
                            <div class="mt-4">
                                <span class="text-blue-400 text-sm font-medium hover:text-blue-300 transition-colors" data-testid="cta-create-now">Create now →</span>
                            </div>
                        </div>

                        <div class="glass-card p-6 cursor-pointer feature-card hover:scale-[1.02] transition-all duration-300" 
                             onclick="switchSection('emails')" 
                             data-testid="dashboard-action-emails">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg flex items-center justify-center feature-icon">
                                    <i data-lucide="mail" class="w-6 h-6 text-white"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-white">Email Portal</h3>
                            </div>
                            <p class="text-gray-400 text-sm serif-text">Manage emails with AI-powered assistance</p>
                            <div class="mt-4 mb-4">
                                <div class="flex items-center gap-2 text-xs text-gray-400">
                                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                    <span>3 unread emails</span>
                                </div>
                                <div class="flex items-center gap-2 text-xs text-gray-400 mt-1">
                                    <div class="w-2 h-2 bg-purple-400 rounded-full"></div>
                                    <span>2 AI responses pending</span>
                                </div>
                            </div>
                            <div class="mt-4">
                                <span class="text-purple-400 text-sm font-medium hover:text-purple-300 transition-colors" data-testid="cta-manage-emails">Manage emails →</span>
                            </div>
                        </div>

                        <div class="glass-card p-6 cursor-pointer feature-card hover:scale-[1.02] transition-all duration-300" 
                             onclick="switchSection('templates')" 
                             data-testid="dashboard-action-templates">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-blue-600 rounded-lg flex items-center justify-center feature-icon">
                                    <i data-lucide="bookmark" class="w-6 h-6 text-white"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-white">Templates</h3>
                            </div>
                            <p class="text-gray-400 text-sm serif-text">Access and manage document templates</p>
                            <div class="mt-4 mb-4">
                                <div class="text-xs text-gray-400">
                                    <span class="text-green-400 font-medium">Most used:</span> Mahnung (1. Stufe)
                                </div>
                                <div class="text-xs text-gray-400 mt-1">
                                    <span class="text-blue-400 font-medium">Recently added:</span> NDA Template
                                </div>
                            </div>
                            <div class="mt-4">
                                <span class="text-green-400 text-sm font-medium hover:text-green-300 transition-colors" data-testid="cta-browse-templates">Browse templates →</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Generator Section -->
                <div class="section-content" id="generator-section">
                    <div class="glass-morphism p-6 mb-6">
                        <div class="text-center">
                            <h2 class="text-3xl font-bold text-white mb-2">AI Document Creator</h2>
                            <p class="text-gray-400">Create, edit, and perfect your legal documents with AI</p>
                        </div>
                    </div>

                    <!-- Side-by-Side Layout -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                        <!-- Left Panel: Input & Controls -->
                        <div class="space-y-6">
                            <!-- File Upload -->
                            <div class="glass-morphism p-6">
                                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                    <i data-lucide="upload" class="w-5 h-5 text-blue-400"></i>
                                    Upload Document (Optional)
                                </h3>
                                
                                <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center hover:border-purple-500 transition-all duration-300">
                                    <input type="file" id="document-upload" accept=".pdf,.doc,.docx,.txt" class="hidden">
                                    <div class="upload-area cursor-pointer" onclick="document.getElementById('document-upload').click()">
                                        <i data-lucide="upload-cloud" class="w-12 h-12 text-gray-400 mx-auto mb-3"></i>
                                        <p class="text-white text-sm font-medium mb-1">Drop file or click to upload</p>
                                        <p class="text-gray-400 text-xs">PDF, DOC, DOCX, TXT</p>
                                    </div>
                                    
                                    <div id="upload-status" class="mt-3 hidden">
                                        <div class="bg-green-500/10 border border-green-500/20 rounded-lg p-3">
                                            <div class="flex items-center gap-2 justify-center">
                                                <i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
                                                <div class="text-center">
                                                    <p class="text-green-400 font-medium text-sm" id="uploaded-filename">Document uploaded</p>
                                                    <p class="text-gray-300 text-xs" id="ai-analysis">Analyzing...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Instructions -->
                            <div class="glass-morphism p-6">
                                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                    <i data-lucide="message-square" class="w-5 h-5 text-purple-400"></i>
                                    AI Instructions
                                </h3>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Document Type</label>
                                        <input type="text" id="doc-objective" class="w-full p-3 glass-card rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-purple-500 border-0 focus:outline-none" placeholder="e.g., Rental Agreement, Legal Notice, Contract...">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Specific Requirements</label>
                                        <textarea id="doc-instructions" rows="4" class="w-full p-3 glass-card rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-purple-500 border-0 focus:outline-none resize-none" placeholder="• Parties involved&#10;• Key terms and conditions&#10;• Special requirements&#10;• Deadlines or dates"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Generate Button -->
                            <div class="glass-morphism p-6">
                                <button id="generate-document-btn" class="w-full py-4 bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg text-white font-semibold text-lg hover:from-purple-600 hover:to-blue-700 transition-all duration-300 flex items-center justify-center gap-3 transform hover:scale-105">
                                    <i data-lucide="sparkles" class="w-6 h-6"></i>
                                    Generate Document
                                </button>
                                
                                <div id="generation-status" class="mt-4 hidden">
                                    <div class="flex items-center gap-3 text-purple-400">
                                        <div class="w-4 h-4 border-2 border-purple-400/30 border-t-purple-400 rounded-full animate-spin"></div>
                                        <span class="text-sm">AI is creating your document...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="glass-morphism p-6">
                                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                    <i data-lucide="zap" class="w-5 h-5 text-yellow-400"></i>
                                    Quick Actions
                                </h3>
                                
                                <div class="grid grid-cols-2 gap-3">
                                    <button class="p-3 glass-card rounded-lg text-gray-300 text-sm hover:text-white hover:bg-white/10 transition-all flex items-center gap-2" id="clear-btn">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        Clear All
                                    </button>
                                    <button class="p-3 glass-card rounded-lg text-gray-300 text-sm hover:text-white hover:bg-white/10 transition-all flex items-center gap-2" id="template-btn">
                                        <i data-lucide="bookmark" class="w-4 h-4"></i>
                                        Templates
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Right Panel: Document Editor -->
                        <div class="space-y-6">
                            <!-- Document Preview/Editor -->
                            <div class="glass-morphism p-6 h-full min-h-[600px] flex flex-col">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                                        <i data-lucide="file-text" class="w-5 h-5 text-green-400"></i>
                                        Document Preview
                                    </h3>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-400" id="word-count">0 words</span>
                                        <button class="p-2 glass-card rounded-lg hover:bg-white/10 transition-colors" id="fullscreen-btn" title="Fullscreen">
                                            <i data-lucide="maximize" class="w-4 h-4 text-gray-400"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Document Content Area -->
                                <div class="flex-1 bg-white rounded-lg p-6 min-h-[400px] relative">
                                    <div id="document-placeholder" class="h-full flex items-center justify-center text-gray-400">
                                        <div class="text-center">
                                            <i data-lucide="file-plus" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                                            <p class="text-lg font-medium text-gray-500 mb-2">No document generated yet</p>
                                            <p class="text-sm text-gray-400">Upload a document or add instructions to get started</p>
                                        </div>
                                    </div>
                                    
                                    <div id="document-editor" class="h-full hidden">
                                        <textarea id="document-content" class="w-full h-full p-4 border-0 resize-none focus:outline-none text-black text-sm leading-relaxed" placeholder="Generated document will appear here..."></textarea>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div id="document-actions" class="flex gap-3 mt-4 hidden">
                                    <button class="flex-1 py-3 bg-gradient-to-r from-green-500 to-green-600 rounded-lg text-white font-semibold hover:from-green-600 hover:to-green-700 transition-all flex items-center justify-center gap-2" id="accept-btn">
                                        <i data-lucide="check" class="w-5 h-5"></i>
                                        Accept
                                    </button>
                                    <button class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg text-white font-semibold hover:from-blue-600 hover:to-blue-700 transition-all flex items-center justify-center gap-2" id="edit-btn">
                                        <i data-lucide="edit-2" class="w-5 h-5"></i>
                                        Edit
                                    </button>
                                    <button class="flex-1 py-3 bg-gradient-to-r from-red-500 to-red-600 rounded-lg text-white font-semibold hover:from-red-600 hover:to-red-700 transition-all flex items-center justify-center gap-2" id="reject-btn">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                        Reject
                                    </button>
                                </div>
                                
                                <!-- Edit Mode Actions -->
                                <div id="edit-actions" class="flex gap-3 mt-4 hidden">
                                    <button class="flex-1 py-3 bg-gradient-to-r from-green-500 to-green-600 rounded-lg text-white font-semibold hover:from-green-600 hover:to-green-700 transition-all flex items-center justify-center gap-2" id="save-btn">
                                        <i data-lucide="save" class="w-5 h-5"></i>
                                        Save Changes
                                    </button>
                                    <button class="flex-1 py-3 bg-gradient-to-r from-gray-500 to-gray-600 rounded-lg text-white font-semibold hover:from-gray-600 hover:to-gray-700 transition-all flex items-center justify-center gap-2" id="cancel-edit-btn">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                        Cancel
                                    </button>
                                    <button class="px-4 py-3 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg text-white font-semibold hover:from-purple-600 hover:to-purple-700 transition-all flex items-center justify-center gap-2" id="download-btn">
                                        <i data-lucide="download" class="w-5 h-5"></i>
                                        Download
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Email Section -->
                <div class="section-content" id="emails-section">
                    <!-- Email Portal Header -->
                    <div class="glass-morphism p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h2 class="text-2xl font-bold text-white mb-2">Email Portal</h2>
                                <p class="text-gray-400 serif-text">Professional legal correspondence management</p>
                            </div>
                            <button class="convert-cta px-4 py-2 rounded-lg text-white font-medium flex items-center gap-2" id="bulk-process-btn">
                                <i data-lucide="zap" class="w-4 h-4"></i>
                                Bulk Process
                            </button>
                        </div>
                        
                        <!-- Quick Filter Bar -->
                        <div class="flex flex-wrap gap-2 mt-4">
                            <div class="filter-tag active" data-filter="all">
                                <i data-lucide="inbox" class="w-4 h-4"></i>
                                All Emails
                            </div>
                            <div class="filter-tag" data-filter="unread">
                                <div class="urgency-indicator urgency-high"></div>
                                Unread (3)
                            </div>
                            <div class="filter-tag" data-filter="mahnung">
                                <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                                Mahnung
                            </div>
                            <div class="filter-tag" data-filter="vertrag">
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                                Vertrag
                            </div>
                            <div class="filter-tag" data-filter="kuendigung">
                                <i data-lucide="x-circle" class="w-4 h-4"></i>
                                Kündigung
                            </div>
                            <div class="filter-tag" data-filter="ai-pending">
                                <i data-lucide="brain" class="w-4 h-4"></i>
                                AI Pending (2)
                            </div>
                        </div>
                    </div>
                    
                    <!-- Email Metrics Bar -->
                    <div class="email-metrics-bar mb-6">
                        <div class="metric-card">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-gray-400">This Week</h3>
                                <i data-lucide="trending-up" class="w-4 h-4 text-green-400"></i>
                            </div>
                            <p class="text-2xl font-bold text-white stat-number" data-target="23">0</p>
                            <p class="text-xs text-green-400 mt-1">+15% from last week</p>
                        </div>
                        
                        <div class="metric-card">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-gray-400">Avg Response Time</h3>
                                <i data-lucide="clock" class="w-4 h-4 text-blue-400"></i>
                            </div>
                            <p class="text-2xl font-bold text-white">2.4h</p>
                            <p class="text-xs text-green-400 mt-1">-20min improvement</p>
                        </div>
                        
                        <div class="metric-card">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-gray-400">AI Suggestions</h3>
                                <i data-lucide="brain" class="w-4 h-4 text-purple-400"></i>
                            </div>
                            <p class="text-2xl font-bold text-white stat-number" data-target="87">0</p>
                            <p class="text-xs text-green-400 mt-1">87% acceptance rate</p>
                        </div>
                        
                        <div class="metric-card">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-gray-400">Follow-ups</h3>
                                <i data-lucide="calendar" class="w-4 h-4 text-yellow-400"></i>
                            </div>
                            <p class="text-2xl font-bold text-white stat-number" data-target="5">0</p>
                            <p class="text-xs text-yellow-400 mt-1">2 due today</p>
                        </div>
                    </div>
                    
                    <!-- Email List Table -->
                    <div class="email-list-table p-6">
                        <div class="grid grid-cols-12 gap-4 mb-4 text-sm font-medium text-gray-400 border-b border-gray-600 pb-3">
                            <div class="col-span-3">Sender</div>
                            <div class="col-span-4">Subject</div>
                            <div class="col-span-2">Date</div>
                            <div class="col-span-1">Type</div>
                            <div class="col-span-1">Status</div>
                            <div class="col-span-1">Actions</div>
                        </div>
                        
                        <div class="space-y-2" id="email-list">
                            <!-- Email Row 1 -->
                            <div class="email-row grid grid-cols-12 gap-4 p-4 rounded-lg items-center" data-email-id="1" style="animation-delay: 0.1s">
                                <div class="col-span-3">
                                    <div class="flex items-center gap-3">
                                        <div class="urgency-indicator urgency-high"></div>
                                        <div>
                                            <p class="font-medium text-white">client@example.com</p>
                                            <p class="text-xs text-gray-400">Max Mustermann</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-span-4">
                                    <p class="font-medium text-white">Anfrage Kaufvertrag Immobilie</p>
                                    <p class="text-xs text-gray-400 mt-1">Sehr geehrte Damen und Herren, ich benötige Unterstützung beim Kauf einer <span class="legal-term">Immobilie</span>...</p>
                                </div>
                                <div class="col-span-2">
                                    <p class="text-sm text-white">2 hours ago</p>
                                    <p class="text-xs text-gray-400">31.07.2025</p>
                                </div>
                                <div class="col-span-1">
                                    <span class="inline-flex items-center px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded-full">
                                        Vertrag
                                    </span>
                                </div>
                                <div class="col-span-1">
                                    <div class="flex items-center gap-1">
                                        <i data-lucide="paperclip" class="w-4 h-4 text-green-400 attachment-icon"></i>
                                        <span class="inline-flex items-center px-2 py-1 bg-red-500/20 text-red-400 text-xs rounded-full">
                                            Unread
                                        </span>
                                    </div>
                                </div>
                                <div class="col-span-1">
                                    <button class="ai-suggest-btn p-2 bg-purple-600 rounded-lg hover:bg-purple-700 transition-colors" title="Generate AI Response">
                                        <i data-lucide="brain" class="w-4 h-4 text-white"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Email Row 2 -->
                            <div class="email-row grid grid-cols-12 gap-4 p-4 rounded-lg items-center" data-email-id="2" style="animation-delay: 0.2s">
                                <div class="col-span-3">
                                    <div class="flex items-center gap-3">
                                        <div class="urgency-indicator urgency-medium"></div>
                                        <div>
                                            <p class="font-medium text-white">partner@lawfirm.de</p>
                                            <p class="text-xs text-gray-400">Kollege Schmidt</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-span-4">
                                    <p class="font-medium text-white">Mandantenvertretung - Herr Schmidt</p>
                                    <p class="text-xs text-gray-400 mt-1">Liebe Kollegin, bezüglich des <span class="legal-term">Mandats</span> von Herr Schmidt möchte ich Sie über...</p>
                                </div>
                                <div class="col-span-2">
                                    <p class="text-sm text-white">5 hours ago</p>
                                    <p class="text-xs text-gray-400">31.07.2025</p>
                                </div>
                                <div class="col-span-1">
                                    <span class="inline-flex items-center px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded-full">
                                        Info
                                    </span>
                                </div>
                                <div class="col-span-1">
                                    <span class="inline-flex items-center px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded-full">
                                        Read
                                    </span>
                                </div>
                                <div class="col-span-1">
                                    <div class="flex gap-1">
                                        <button class="convert-cta p-2 rounded-lg text-white text-xs" title="Convert to Document">
                                            <i data-lucide="file-plus" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Email Row 3 -->
                            <div class="email-row grid grid-cols-12 gap-4 p-4 rounded-lg items-center" data-email-id="3" style="animation-delay: 0.3s">
                                <div class="col-span-3">
                                    <div class="flex items-center gap-3">
                                        <div class="urgency-indicator urgency-high"></div>
                                        <div>
                                            <p class="font-medium text-white">opposing@counsel.de</p>
                                            <p class="text-xs text-gray-400">RA Weber</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-span-4">
                                    <p class="font-medium text-white">Vergleichsvorschlag - Sache Weber</p>
                                    <p class="text-xs text-gray-400 mt-1">Sehr geehrte Damen und Herren, in der Sache Weber ./. Mueller möchten wir Ihnen folgenden <span class="legal-term">Vergleichsvorschlag</span>...</p>
                                </div>
                                <div class="col-span-2">
                                    <p class="text-sm text-white">1 day ago</p>
                                    <p class="text-xs text-gray-400">30.07.2025</p>
                                </div>
                                <div class="col-span-1">
                                    <span class="inline-flex items-center px-2 py-1 bg-yellow-500/20 text-yellow-400 text-xs rounded-full">
                                        Vergleich
                                    </span>
                                </div>
                                <div class="col-span-1">
                                    <div class="flex items-center gap-1">
                                        <i data-lucide="paperclip" class="w-4 h-4 text-green-400 attachment-icon"></i>
                                        <span class="inline-flex items-center px-2 py-1 bg-purple-500/20 text-purple-400 text-xs rounded-full">
                                            AI Draft
                                        </span>
                                    </div>
                                </div>
                                <div class="col-span-1">
                                    <button class="p-2 bg-green-600 rounded-lg hover:bg-green-700 transition-colors" title="Review AI Response">
                                        <i data-lucide="eye" class="w-4 h-4 text-white"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Load More -->
                        <div class="mt-6 text-center">
                            <button class="px-6 py-3 bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg text-white font-medium hover:from-purple-600 hover:to-blue-700 transition-all">
                                Load More Emails
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Email Preview Pane -->
                <div class="email-preview-pane" id="email-preview-pane">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-semibold text-white">Email Details</h3>
                            <button class="p-2 hover:bg-white/10 rounded-lg transition-colors" id="close-preview">
                                <i data-lucide="x" class="w-5 h-5 text-gray-400"></i>
                            </button>
                        </div>
                        
                        <!-- Email Header -->
                        <div class="mb-6" id="email-header">
                            <div class="skeleton-loader h-6 w-3/4 mb-2"></div>
                            <div class="skeleton-loader h-4 w-1/2 mb-4"></div>
                            <div class="skeleton-loader h-4 w-full mb-2"></div>
                            <div class="skeleton-loader h-4 w-2/3"></div>
                        </div>
                        
                        <!-- Attachment Slider -->
                        <div class="mb-6" id="attachment-section" style="display: none;">
                            <h4 class="text-sm font-medium text-gray-400 mb-3">Attachments</h4>
                            <div class="attachment-slider">
                                <div class="attachment-item flex flex-col items-center justify-center">
                                    <i data-lucide="file-text" class="w-6 h-6 text-blue-400 mb-2 attachment-icon"></i>
                                    <p class="text-xs text-gray-400">Contract.pdf</p>
                                    <div class="absolute top-1 right-1">
                                        <span class="inline-flex items-center px-1 py-0.5 bg-green-500/20 text-green-400 text-xs rounded">
                                            ✓ OCR
                                        </span>
                                    </div>
                                </div>
                                <div class="attachment-item flex flex-col items-center justify-center">
                                    <i data-lucide="image" class="w-6 h-6 text-purple-400 mb-2 attachment-icon"></i>
                                    <p class="text-xs text-gray-400">Scan.jpg</p>
                                    <div class="absolute top-1 right-1">
                                        <span class="inline-flex items-center px-1 py-0.5 bg-yellow-500/20 text-yellow-400 text-xs rounded">
                                            Pending
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Email Content -->
                        <div class="mb-6" id="email-content">
                            <div class="skeleton-loader h-4 w-full mb-2"></div>
                            <div class="skeleton-loader h-4 w-full mb-2"></div>
                            <div class="skeleton-loader h-4 w-3/4 mb-2"></div>
                            <div class="skeleton-loader h-4 w-full mb-2"></div>
                            <div class="skeleton-loader h-4 w-2/3"></div>
                        </div>
                        
                        <!-- AI Actions -->
                        <div class="space-y-3">
                            <button class="w-full ai-suggest-btn p-3 bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg text-white font-medium flex items-center justify-center gap-2 hover:from-purple-600 hover:to-blue-700 transition-all">
                                <i data-lucide="brain" class="w-5 h-5"></i>
                                Generate AI Response
                            </button>
                            
                            <button class="w-full convert-cta p-3 rounded-lg text-white font-medium flex items-center justify-center gap-2">
                                <i data-lucide="file-plus" class="w-5 h-5"></i>
                                Convert to Document
                            </button>
                            
                            <button class="w-full p-3 bg-gray-600 rounded-lg text-white font-medium flex items-center justify-center gap-2 hover:bg-gray-700 transition-colors">
                                <i data-lucide="calendar-plus" class="w-5 h-5"></i>
                                Schedule Follow-up
                            </button>
                        </div>
                        
                        <!-- Thread Timeline -->
                        <div class="mt-8" id="thread-timeline" style="display: none;">
                            <h4 class="text-sm font-medium text-gray-400 mb-4">Conversation Thread</h4>
                            <div class="thread-timeline">
                                <div class="thread-item client">
                                    <div class="glass-card p-4">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-sm font-medium text-white">Max Mustermann</span>
                                            <span class="text-xs text-gray-400">2 hours ago</span>
                                        </div>
                                        <p class="text-sm text-gray-300">Initial inquiry about property purchase contract...</p>
                                    </div>
                                </div>
                                
                                <div class="thread-item ai" style="animation-delay: 0.2s">
                                    <div class="glass-card p-4">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-sm font-medium text-purple-400">AI Assistant</span>
                                            <span class="text-xs text-gray-400">1 hour ago</span>
                                        </div>
                                        <p class="text-sm text-gray-300">Generated draft response with legal requirements...</p>
                                    </div>
                                </div>
                                
                                <div class="thread-item user" style="animation-delay: 0.4s">
                                    <div class="glass-card p-4">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-sm font-medium text-blue-400">Dr. Anna Vogel</span>
                                            <span class="text-xs text-gray-400">30 min ago</span>
                                        </div>
                                        <p class="text-sm text-gray-300">Reviewed and approved AI response with minor modifications...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Templates Section -->
                <div class="section-content" id="templates-section">
                    <!-- Templates Header -->
                    <div class="glass-morphism p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h2 class="text-2xl font-bold text-white mb-2">Template Library</h2>
                                <p class="text-gray-400 serif-text">Professional legal document templates with AI assistance</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 rounded-lg text-white font-medium flex items-center gap-2 hover:from-green-600 hover:to-green-700 transition-all" id="import-templates-btn">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    Import
                                </button>
                                <button class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg text-white font-medium flex items-center gap-2 hover:from-blue-600 hover:to-blue-700 transition-all" id="filter-templates-btn">
                                    <i data-lucide="filter" class="w-4 h-4"></i>
                                    Filter
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Suggested Templates Bar -->
                    <div class="suggested-templates-bar">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-gradient-to-r from-teal-400 to-teal-500 rounded-lg flex items-center justify-center">
                                <i data-lucide="brain" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white">AI Suggested Templates</h3>
                                <p class="text-sm text-gray-400">Based on your recent document activity</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white/5 rounded-lg p-4 cursor-pointer hover:bg-white/10 transition-colors">
                                <div class="flex items-center gap-3 mb-2">
                                    <i data-lucide="file-text" class="w-5 h-5 text-teal-400"></i>
                                    <h4 class="font-medium text-white">Kaufvertrag Immobilie</h4>
                                </div>
                                <p class="text-xs text-gray-400 mb-2">Used 3x this week</p>
                                <div class="flex items-center gap-2">
                                    <span class="template-tag system">System</span>
                                    <span class="text-xs text-teal-400">92% match</span>
                                </div>
                            </div>
                            <div class="bg-white/5 rounded-lg p-4 cursor-pointer hover:bg-white/10 transition-colors">
                                <div class="flex items-center gap-3 mb-2">
                                    <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-400"></i>
                                    <h4 class="font-medium text-white">Mahnung (2. Stufe)</h4>
                                </div>
                                <p class="text-xs text-gray-400 mb-2">Frequently requested</p>
                                <div class="flex items-center gap-2">
                                    <span class="template-tag custom">Custom</span>
                                    <span class="text-xs text-teal-400">87% match</span>
                                </div>
                            </div>
                            <div class="bg-white/5 rounded-lg p-4 cursor-pointer hover:bg-white/10 transition-colors">
                                <div class="flex items-center gap-3 mb-2">
                                    <i data-lucide="shield" class="w-5 h-5 text-purple-400"></i>
                                    <h4 class="font-medium text-white">Geheimhaltungsvereinbarung</h4>
                                </div>
                                <p class="text-xs text-gray-400 mb-2">Similar to last document</p>
                                <div class="flex items-center gap-2">
                                    <span class="template-tag system">System</span>
                                    <span class="text-xs text-teal-400">78% match</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Template Usage Analytics -->
                    <div class="template-usage-analytics">
                        <div class="analytics-card">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">Most Used Templates</h3>
                                <i data-lucide="bar-chart-3" class="w-5 h-5 text-purple-400"></i>
                            </div>
                            <div class="chart-container">
                                <div class="flex flex-col items-center">
                                    <div class="chart-bar" style="height: 80%; animation-delay: 0.1s;" title="Mahnung - 45 uses"></div>
                                    <span class="text-xs text-gray-400 mt-2">Mahnung</span>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="chart-bar" style="height: 65%; animation-delay: 0.2s;" title="Vertrag - 32 uses"></div>
                                    <span class="text-xs text-gray-400 mt-2">Vertrag</span>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="chart-bar" style="height: 50%; animation-delay: 0.3s;" title="NDA - 24 uses"></div>
                                    <span class="text-xs text-gray-400 mt-2">NDA</span>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="chart-bar" style="height: 40%; animation-delay: 0.4s;" title="Kündigung - 18 uses"></div>
                                    <span class="text-xs text-gray-400 mt-2">Kündigung</span>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="chart-bar" style="height: 30%; animation-delay: 0.5s;" title="Vollmacht - 12 uses"></div>
                                    <span class="text-xs text-gray-400 mt-2">Vollmacht</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">Template Performance</h3>
                                <i data-lucide="trending-up" class="w-5 h-5 text-green-400"></i>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm text-gray-400">Success Rate</span>
                                        <span class="text-lg font-bold text-white stat-number" data-target="94">0</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="transform: translateX(-6%)"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm text-gray-400">Avg. Generation Time</span>
                                        <span class="text-lg font-bold text-white">2.3s</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm text-gray-400">User Satisfaction</span>
                                        <span class="text-lg font-bold text-white stat-number" data-target="89">0</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="transform: translateX(-11%)"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white">Weekly Activity</h3>
                                <i data-lucide="calendar" class="w-5 h-5 text-blue-400"></i>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-400">Templates Created</span>
                                    <span class="text-white font-semibold stat-number" data-target="7">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-400">Templates Used</span>
                                    <span class="text-white font-semibold stat-number" data-target="156">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-400">AI Enhancements</span>
                                    <span class="text-white font-semibold stat-number" data-target="23">0</span>
                                </div>
                                <div class="mt-4 text-center">
                                    <span class="text-xs text-green-400">+12% from last week</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Clause Library -->
                    <div class="clause-library">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <i data-lucide="layers" class="w-5 h-5 text-teal-400"></i>
                                <h3 class="text-lg font-semibold text-white">Clause Library</h3>
                            </div>
                            <button class="text-sm text-teal-400 hover:text-teal-300 transition-colors">View All</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="clause-item">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-white">Standardgewährleistung</span>
                                    <i data-lucide="copy" class="w-4 h-4 text-gray-400 hover:text-white cursor-pointer"></i>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Für alle Vertragsarten anwendbar</p>
                            </div>
                            <div class="clause-item">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-white">Zahlungsfristen</span>
                                    <i data-lucide="copy" class="w-4 h-4 text-gray-400 hover:text-white cursor-pointer"></i>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Standard 14 Tage Zahlungsziel</p>
                            </div>
                            <div class="clause-item">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-white">Datenschutzklausel</span>
                                    <i data-lucide="copy" class="w-4 h-4 text-gray-400 hover:text-white cursor-pointer"></i>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">DSGVO-konforme Standardklausel</p>
                            </div>
                            <div class="clause-item">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-white">Gerichtsstandsklausel</span>
                                    <i data-lucide="copy" class="w-4 h-4 text-gray-400 hover:text-white cursor-pointer"></i>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Deutsches Recht, Gerichtsstand München</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Template Card Grid -->
                    <div class="template-card-grid" id="template-grid">
                        <!-- Template Card 1 -->
                        <div class="template-card" style="--animation-delay: 0.1s; animation-delay: 0.1s" data-template-id="1" data-testid="template-card-1">
                            <div class="template-border-glow"></div>
                            <div class="relative z-10">
                                <div class="flex items-start justify-between mb-4">
                                    <div>
                                        <h3 class="template-title text-lg font-semibold text-white mb-2">Mahnung (1. Stufe)</h3>
                                        <p class="template-description text-sm text-gray-400 serif-text">Erste Zahlungserinnerung für offene Forderungen</p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="success-rate-badge text-xs px-2 py-1 bg-green-500/20 text-green-400 rounded-full">
                                            96% success
                                            <div class="success-rate-tooltip">
                                                Historical Success Rate
                                                <div class="mini-chart">
                                                    <span class="chart-bar-mini" style="height: 18px; transform: scaleY(0.9);"></span>
                                                    <span class="chart-bar-mini" style="height: 16px; transform: scaleY(0.95);"></span>
                                                    <span class="chart-bar-mini" style="height: 20px; transform: scaleY(1);"></span>
                                                    <span class="chart-bar-mini" style="height: 19px; transform: scaleY(0.96);"></span>
                                                    <span class="chart-bar-mini" style="height: 18px; transform: scaleY(0.92);"></span>
                                                </div>
                                            </div>
                                        </span>
                                        <button class="p-2 hover:bg-white/10 rounded-lg transition-colors edit-template-btn" title="Edit Template" data-template-id="1">
                                            <i data-lucide="edit-2" class="w-4 h-4 text-gray-400"></i>
                                        </button>
                                        <button class="p-2 hover:bg-white/10 rounded-lg transition-colors" title="More Options">
                                            <i data-lucide="more-vertical" class="w-4 h-4 text-gray-400"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flex flex-wrap gap-2 mb-4">
                                    <span class="template-tag system">System</span>
                                    <span class="template-tag custom">Mahnung</span>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                                    <div>
                                        <span class="text-gray-400">Created by:</span>
                                        <p class="text-white font-medium">System</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Last used:</span>
                                        <p class="text-white font-medium">2 days ago</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Usage count:</span>
                                        <p class="text-white font-medium">45 times</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Success rate:</span>
                                        <p class="text-green-400 font-medium">96%</p>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button class="use-template-btn flex-1 py-2 bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg text-white font-medium hover:from-purple-600 hover:to-blue-700 transition-all" 
                                            data-template-id="{{ template_id }}" 
                                            data-testid="use-template-{{ template_id }}">
                                        Use Template
                                    </button>
                                    <button class="duplicate-template-btn p-2 bg-gray-600 rounded-lg text-white hover:bg-gray-700 transition-colors" 
                                            title="Duplicate" 
                                            data-template-id="{{ template_id }}"
                                            data-testid="duplicate-template-{{ template_id }}">
                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Template Card 2 -->
                        <div class="template-card" style="--animation-delay: 0.2s; animation-delay: 0.2s" data-template-id="2" data-testid="template-card-2">
                            <div class="template-border-glow"></div>
                            <div class="relative z-10">
                                <div class="flex items-start justify-between mb-4">
                                    <div>
                                        <h3 class="template-title text-lg font-semibold text-white mb-2">Geheimhaltungsvereinbarung</h3>
                                        <p class="template-description text-sm text-gray-400 serif-text">NDA für vertrauliche Geschäftsinformationen</p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="success-rate-badge text-xs px-2 py-1 bg-green-500/20 text-green-400 rounded-full">
                                            91% success
                                            <div class="success-rate-tooltip">
                                                Historical Success Rate
                                                <div class="mini-chart">
                                                    <span class="chart-bar-mini" style="height: 16px; transform: scaleY(0.85);"></span>
                                                    <span class="chart-bar-mini" style="height: 18px; transform: scaleY(0.9);"></span>
                                                    <span class="chart-bar-mini" style="height: 17px; transform: scaleY(0.88);"></span>
                                                    <span class="chart-bar-mini" style="height: 19px; transform: scaleY(0.92);"></span>
                                                    <span class="chart-bar-mini" style="height: 18px; transform: scaleY(0.91);"></span>
                                                </div>
                                            </div>
                                        </span>
                                        <button class="p-2 hover:bg-white/10 rounded-lg transition-colors edit-template-btn" title="Edit Template" data-template-id="2">
                                            <i data-lucide="edit-2" class="w-4 h-4 text-gray-400"></i>
                                        </button>
                                        <button class="p-2 hover:bg-white/10 rounded-lg transition-colors" title="More Options">
                                            <i data-lucide="more-vertical" class="w-4 h-4 text-gray-400"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flex flex-wrap gap-2 mb-4">
                                    <span class="template-tag system">System</span>
                                    <span class="template-tag custom">Vertrag</span>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                                    <div>
                                        <span class="text-gray-400">Created by:</span>
                                        <p class="text-white font-medium">System</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Last used:</span>
                                        <p class="text-white font-medium">1 week ago</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Usage count:</span>
                                        <p class="text-white font-medium">24 times</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Success rate:</span>
                                        <p class="text-green-400 font-medium">91%</p>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button class="use-template-btn flex-1 py-2 bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg text-white font-medium hover:from-purple-600 hover:to-blue-700 transition-all" 
                                            data-template-id="2" 
                                            data-testid="use-template-2">
                                        Use Template
                                    </button>
                                    <button class="copy-template-btn p-2 bg-gray-600 rounded-lg text-white hover:bg-gray-700 transition-colors" 
                                            title="Copy to Clipboard" 
                                            data-template-id="2"
                                            data-testid="copy-template-2">
                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Template Card 3 -->
                        <div class="template-card" style="--animation-delay: 0.3s; animation-delay: 0.3s" data-template-id="3" data-testid="template-card-3">
                            <div class="template-border-glow"></div>
                            <div class="relative z-10">
                                <div class="flex items-start justify-between mb-4">
                                    <div>
                                        <h3 class="template-title text-lg font-semibold text-white mb-2">Kündigung Arbeitsvertrag</h3>
                                        <p class="template-description text-sm text-gray-400 serif-text">Ordentliche Kündigung eines Arbeitsverhältnisses</p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="success-rate-badge text-xs px-2 py-1 bg-green-500/20 text-green-400 rounded-full">
                                            89% success
                                            <div class="success-rate-tooltip">
                                                Historical Success Rate
                                                <div class="mini-chart">
                                                    <span class="chart-bar-mini" style="height: 15px; transform: scaleY(0.82);"></span>
                                                    <span class="chart-bar-mini" style="height: 17px; transform: scaleY(0.87);"></span>
                                                    <span class="chart-bar-mini" style="height: 16px; transform: scaleY(0.85);"></span>
                                                    <span class="chart-bar-mini" style="height: 18px; transform: scaleY(0.89);"></span>
                                                    <span class="chart-bar-mini" style="height: 17px; transform: scaleY(0.88);"></span>
                                                </div>
                                            </div>
                                        </span>
                                        <button class="p-2 hover:bg-white/10 rounded-lg transition-colors edit-template-btn" title="Edit Template" data-template-id="3">
                                            <i data-lucide="edit-2" class="w-4 h-4 text-gray-400"></i>
                                        </button>
                                        <button class="p-2 hover:bg-white/10 rounded-lg transition-colors" title="More Options">
                                            <i data-lucide="more-vertical" class="w-4 h-4 text-gray-400"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flex flex-wrap gap-2 mb-4">
                                    <span class="template-tag system">System</span>
                                    <span class="template-tag draft">Employment</span>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                                    <div>
                                        <span class="text-gray-400">Created by:</span>
                                        <p class="text-white font-medium">System</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Last used:</span>
                                        <p class="text-white font-medium">3 days ago</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Usage count:</span>
                                        <p class="text-white font-medium">18 times</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Success rate:</span>
                                        <p class="text-green-400 font-medium">89%</p>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button class="use-template-btn flex-1 py-2 bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg text-white font-medium hover:from-purple-600 hover:to-blue-700 transition-all" 
                                            data-template-id="3" 
                                            data-testid="use-template-3">
                                        Use Template
                                    </button>
                                    <button class="copy-template-btn p-2 bg-gray-600 rounded-lg text-white hover:bg-gray-700 transition-colors" 
                                            title="Copy to Clipboard" 
                                            data-template-id="3"
                                            data-testid="copy-template-3">
                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Template Card 4 -->
                        <div class="template-card" style="--animation-delay: 0.4s; animation-delay: 0.4s" data-template-id="4" data-testid="template-card-4">
                            <div class="template-border-glow"></div>
                            <div class="relative z-10">
                                <div class="flex items-start justify-between mb-4">
                                    <div>
                                        <h3 class="template-title text-lg font-semibold text-white mb-2">Kaufvertrag Immobilie</h3>
                                        <p class="template-description text-sm text-gray-400 serif-text">Vollständiger Kaufvertrag für Immobilienerwerb</p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="success-rate-badge text-xs px-2 py-1 bg-green-500/20 text-green-400 rounded-full">
                                            94% success
                                            <div class="success-rate-tooltip">
                                                Historical Success Rate
                                                <div class="mini-chart">
                                                    <span class="chart-bar-mini" style="height: 17px; transform: scaleY(0.88);"></span>
                                                    <span class="chart-bar-mini" style="height: 19px; transform: scaleY(0.93);"></span>
                                                    <span class="chart-bar-mini" style="height: 18px; transform: scaleY(0.91);"></span>
                                                    <span class="chart-bar-mini" style="height: 20px; transform: scaleY(0.95);"></span>
                                                    <span class="chart-bar-mini" style="height: 19px; transform: scaleY(0.94);"></span>
                                                </div>
                                            </div>
                                        </span>
                                        <button class="p-2 hover:bg-white/10 rounded-lg transition-colors edit-template-btn" title="Edit Template" data-template-id="4">
                                            <i data-lucide="edit-2" class="w-4 h-4 text-gray-400"></i>
                                        </button>
                                        <button class="p-2 hover:bg-white/10 rounded-lg transition-colors" title="More Options">
                                            <i data-lucide="more-vertical" class="w-4 h-4 text-gray-400"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flex flex-wrap gap-2 mb-4">
                                    <span class="template-tag custom">Custom</span>
                                    <span class="template-tag system">Real Estate</span>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                                    <div>
                                        <span class="text-gray-400">Created by:</span>
                                        <p class="text-white font-medium">Dr. Anna Vogel</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Last used:</span>
                                        <p class="text-white font-medium">Today</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Usage count:</span>
                                        <p class="text-white font-medium">12 times</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Success rate:</span>
                                        <p class="text-green-400 font-medium">94%</p>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button class="use-template-btn flex-1 py-2 bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg text-white font-medium hover:from-purple-600 hover:to-blue-700 transition-all" 
                                            data-template-id="4" 
                                            data-testid="use-template-4">
                                        Use Template
                                    </button>
                                    <button class="copy-template-btn p-2 bg-gray-600 rounded-lg text-white hover:bg-gray-700 transition-colors" 
                                            title="Copy to Clipboard" 
                                            data-template-id="4"
                                            data-testid="copy-template-4">
                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="fab" id="fab-button">
        <i data-lucide="plus" class="w-6 h-6 text-white"></i>
    </div>
    
    <!-- FAB Menu -->
    <div class="fab-menu" id="fab-menu">
        <div class="fab-item" onclick="switchSection('generator')">
            <i data-lucide="file-plus" class="w-5 h-5"></i>
            <span>New Document</span>
        </div>
        <div class="fab-item" onclick="window.dashboard.openCreateTemplateModal()">
            <i data-lucide="bookmark-plus" class="w-5 h-5"></i>
            <span>Create Template</span>
        </div>
    </div>

    <!-- AI Suggestions Panel -->
    <div class="ai-suggestions" id="ai-suggestions">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <i data-lucide="brain" class="w-5 h-5 text-purple-400"></i>
                <h3 class="font-semibold text-white">AI Suggestions</h3>
            </div>
            <button class="p-1 hover:bg-white/10 rounded transition-colors" id="close-ai-suggestions" title="Close suggestions">
                <i data-lucide="x" class="w-4 h-4 text-gray-400"></i>
            </button>
        </div>
        <div class="space-y-3" id="ai-suggestions-list">
            <div class="ai-suggestion-item p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition-colors" data-suggestion-id="1">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <i data-lucide="trending-up" class="w-4 h-4 text-green-400"></i>
                            <span class="text-sm font-medium text-white">Most Popular</span>
                        </div>
                        <p class="text-xs text-gray-400">Mahnung templates used 15x this week</p>
                    </div>
                    <div class="flex items-center gap-1 ml-2">
                        <button class="pin-suggestion p-1 hover:bg-yellow-500/20 rounded" title="Pin suggestion" data-suggestion-id="1">
                            <i data-lucide="pin" class="w-3 h-3 text-gray-500 hover:text-yellow-400"></i>
                        </button>
                        <button class="dismiss-suggestion p-1 hover:bg-red-500/20 rounded" title="Dismiss suggestion" data-suggestion-id="1">
                            <i data-lucide="x" class="w-3 h-3 text-gray-500 hover:text-red-400"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="ai-suggestion-item p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition-colors applied" data-suggestion-id="2">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <i data-lucide="clock" class="w-4 h-4 text-blue-400"></i>
                            <span class="text-sm font-medium text-white">Quick Action</span>
                            <span class="text-xs px-2 py-0.5 bg-green-500/20 text-green-400 rounded-full">Used</span>
                        </div>
                        <p class="text-xs text-gray-400">Generate contract from last template</p>
                    </div>
                    <div class="flex items-center gap-1 ml-2">
                        <button class="pin-suggestion pinned p-1 hover:bg-yellow-500/20 rounded" title="Unpin suggestion" data-suggestion-id="2">
                            <i data-lucide="pin" class="w-3 h-3 text-yellow-400"></i>
                        </button>
                        <button class="dismiss-suggestion p-1 hover:bg-red-500/20 rounded" title="Dismiss suggestion" data-suggestion-id="2">
                            <i data-lucide="x" class="w-3 h-3 text-gray-500 hover:text-red-400"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="ai-suggestion-item p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition-colors" data-suggestion-id="3">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <i data-lucide="lightbulb" class="w-4 h-4 text-yellow-400"></i>
                            <span class="text-sm font-medium text-white">Tip</span>
                        </div>
                        <p class="text-xs text-gray-400">Use bulk email processing for efficiency</p>
                    </div>
                    <div class="flex items-center gap-1 ml-2">
                        <button class="pin-suggestion p-1 hover:bg-yellow-500/20 rounded" title="Pin suggestion" data-suggestion-id="3">
                            <i data-lucide="pin" class="w-3 h-3 text-gray-500 hover:text-yellow-400"></i>
                        </button>
                        <button class="dismiss-suggestion p-1 hover:bg-red-500/20 rounded" title="Dismiss suggestion" data-suggestion-id="3">
                            <i data-lucide="x" class="w-3 h-3 text-gray-500 hover:text-red-400"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex items-center justify-between mt-4 pt-3 border-t border-white/10">
            <p class="text-xs text-gray-500">Auto-refresh in <span id="suggestion-countdown">12h</span></p>
            <button class="py-1 px-3 bg-gradient-to-r from-purple-500 to-blue-600 rounded text-white text-xs hover:from-purple-600 hover:to-blue-700 transition-all" id="refresh-suggestions">
                Refresh Now
            </button>
        </div>
    </div>

    <!-- Legal Clipboard Widget -->
    <div class="legal-clipboard" id="legal-clipboard">
        <div class="flex items-center gap-2 mb-2">
            <i data-lucide="clipboard" class="w-4 h-4 text-green-400"></i>
            <h4 class="font-medium text-white text-sm">Legal Clipboard</h4>
        </div>
        <div class="text-xs text-gray-400 mb-3">Recent snippets for reuse</div>
        <div class="space-y-2 max-h-40 overflow-y-auto">
            <div class="p-2 bg-white/5 rounded text-xs text-gray-300 cursor-pointer hover:bg-white/10">
                "Sehr geehrte Damen und Herren, hiermit kündigen wir..."
            </div>
            <div class="p-2 bg-white/5 rounded text-xs text-gray-300 cursor-pointer hover:bg-white/10">
                "Zahlungsfrist: 14 Tage nach Erhalt"
            </div>
            <div class="p-2 bg-white/5 rounded text-xs text-gray-300 cursor-pointer hover:bg-white/10">
                "Mit freundlichen Grüßen, Rechtsanwaltskanzlei..."
            </div>
        </div>
        <button class="w-full mt-3 py-1 bg-gradient-to-r from-green-500 to-green-600 rounded text-white text-xs hover:from-green-600 hover:to-green-700 transition-all">
            Clear Clipboard
        </button>
    </div>


    <!-- Template Filter Sidebar -->
    <div class="template-filter-sidebar" id="template-filter-sidebar">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-white">Filter Templates</h3>
                <button class="p-2 hover:bg-white/10 rounded-lg transition-colors" id="close-filter-sidebar">
                    <i data-lucide="x" class="w-5 h-5 text-gray-400"></i>
                </button>
            </div>
            
            <!-- Search Bar -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-400 mb-2">Search Templates</label>
                <div class="relative">
                    <input type="text" class="w-full p-3 bg-white/5 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-purple-500 border-0 focus:outline-none pl-10" placeholder="Search by name or content...">
                    <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
                </div>
            </div>
            
            <!-- Filter by Type -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-400 mb-3">Template Type</label>
                <div class="flex flex-wrap gap-2">
                    <div class="filter-chip active" data-filter="all" style="animation-delay: 0.1s">
                        <i data-lucide="inbox" class="w-4 h-4"></i>
                        All
                    </div>
                    <div class="filter-chip" data-filter="mahnung" style="animation-delay: 0.2s">
                        <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                        Mahnung
                    </div>
                    <div class="filter-chip" data-filter="nda" style="animation-delay: 0.3s">
                        <i data-lucide="shield" class="w-4 h-4"></i>
                        NDA
                    </div>
                    <div class="filter-chip" data-filter="kuendigung" style="animation-delay: 0.4s">
                        <i data-lucide="x-circle" class="w-4 h-4"></i>
                        Kündigung
                    </div>
                    <div class="filter-chip" data-filter="vertrag" style="animation-delay: 0.5s">
                        <i data-lucide="file-text" class="w-4 h-4"></i>
                        Vertrag
                    </div>
                </div>
            </div>
            
            <!-- Filter by Owner -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-400 mb-3">Created By</label>
                <div class="space-y-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="owner" value="me" class="text-purple-500">
                        <span class="text-white">My Templates</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="owner" value="team" class="text-purple-500">
                        <span class="text-white">Team Templates</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="owner" value="admin" class="text-purple-500" checked>
                        <span class="text-white">System Templates</span>
                    </label>
                </div>
            </div>
            
            <!-- Date Range -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-400 mb-3">Date Range</label>
                <select class="w-full p-3 bg-white/5 rounded-lg text-white focus:ring-2 focus:ring-purple-500 border-0 focus:outline-none">
                    <option>Last 7 days</option>
                    <option>Last 30 days</option>
                    <option>Last 3 months</option>
                    <option>All time</option>
                </select>
            </div>
            
            <!-- Favorites Toggle -->
            <div class="mb-6">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" class="text-purple-500">
                    <span class="text-white">Show only favorites</span>
                    <i data-lucide="star" class="w-4 h-4 text-yellow-400"></i>
                </label>
            </div>
            
            <!-- Apply Filters -->
            <div class="space-y-3">
                <button class="w-full py-3 bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg text-white font-medium hover:from-purple-600 hover:to-blue-700 transition-all">
                    Apply Filters
                </button>
                <button class="w-full py-2 bg-gray-600 rounded-lg text-white hover:bg-gray-700 transition-colors">
                    Clear All
                </button>
            </div>
        </div>
    </div>

    <!-- Import/Export Modal -->
    <div class="import-export-modal" id="import-export-modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-white">Import Templates</h3>
                <button class="p-2 hover:bg-white/10 rounded-lg transition-colors" id="close-import-modal">
                    <i data-lucide="x" class="w-5 h-5 text-gray-400"></i>
                </button>
            </div>
            
            <!-- Drop Zone -->
            <div class="drop-zone" id="drop-zone">
                <div class="drop-icon">
                    <i data-lucide="upload-cloud" class="w-16 h-16 text-purple-400 mx-auto mb-4"></i>
                </div>
                <h4 class="text-lg font-semibold text-white mb-2">Drop files here or click to browse</h4>
                <p class="text-gray-400 text-sm mb-4">Supports DOCX, Markdown, and JSON formats</p>
                <input type="file" id="template-file-input" class="hidden" accept=".docx,.md,.json" multiple>
                <button class="px-6 py-3 bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg text-white font-medium hover:from-purple-600 hover:to-blue-700 transition-all">
                    Choose Files
                </button>
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-bar" id="import-progress" style="display: none;">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            
            <!-- Export Options -->
            <div class="mt-6 pt-6 border-t border-gray-600">
                <h4 class="text-lg font-semibold text-white mb-4">Export Templates</h4>
                <div class="grid grid-cols-3 gap-3">
                    <button class="p-3 bg-white/5 rounded-lg text-center hover:bg-white/10 transition-colors">
                        <i data-lucide="file-text" class="w-6 h-6 text-red-400 mx-auto mb-2"></i>
                        <span class="text-sm text-white">PDF</span>
                    </button>
                    <button class="p-3 bg-white/5 rounded-lg text-center hover:bg-white/10 transition-colors">
                        <i data-lucide="file-text" class="w-6 h-6 text-blue-400 mx-auto mb-2"></i>
                        <span class="text-sm text-white">DOCX</span>
                    </button>
                    <button class="p-3 bg-white/5 rounded-lg text-center hover:bg-white/10 transition-colors">
                        <i data-lucide="code" class="w-6 h-6 text-green-400 mx-auto mb-2"></i>
                        <span class="text-sm text-white">JSON</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Professional Footer -->
    <footer class="glass-morphism mt-6 mx-6 mb-6">
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Company Info -->
                <div class="md:col-span-1">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2L2 7v10c0 5.55 3.84 9.95 9 11 5.16-1.05 9-5.45 9-11V7l-10-5z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-white">AnwaltsAI</h3>
                    </div>
                    <p class="text-gray-400 text-sm">Professional Legal AI Platform for modern law firms</p>
                    <div class="mt-4 text-xs text-gray-500">
                        <p>© 2025 AnwaltsAI. All rights reserved.</p>
                        <p>Version 1.0.0</p>
                    </div>
                </div>

                <!-- Quick Links -->
                <div>
                    <h4 class="text-white font-semibold mb-3">Quick Access</h4>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors cursor-pointer" onclick="switchSection('dashboard')">Dashboard</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors cursor-pointer" onclick="switchSection('generator')">Document Generator</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors cursor-pointer" onclick="switchSection('emails')">Email Portal</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors cursor-pointer" onclick="switchSection('templates')">Templates</a></li>
                    </ul>
                </div>

                <!-- Legal Resources -->
                <div>
                    <h4 class="text-white font-semibold mb-3">Legal Resources</h4>
                    <ul class="space-y-2 text-sm">
                        <li><a href="https://dejure.org" target="_blank" class="text-gray-400 hover:text-white transition-colors flex items-center gap-1">dejure.org <i data-lucide="external-link" class="w-3 h-3"></i></a></li>
                        <li><a href="https://beck-online.de" target="_blank" class="text-gray-400 hover:text-white transition-colors flex items-center gap-1">Beck-Online <i data-lucide="external-link" class="w-3 h-3"></i></a></li>
                        <li><a href="https://juris.de" target="_blank" class="text-gray-400 hover:text-white transition-colors flex items-center gap-1">Juris <i data-lucide="external-link" class="w-3 h-3"></i></a></li>
                        <li><a href="https://bundesanzeiger.de" target="_blank" class="text-gray-400 hover:text-white transition-colors flex items-center gap-1">Bundesanzeiger <i data-lucide="external-link" class="w-3 h-3"></i></a></li>
                    </ul>
                </div>

                <!-- Professional Associations -->
                <div>
                    <h4 class="text-white font-semibold mb-3">Professional Associations</h4>
                    <ul class="space-y-2 text-sm">
                        <li><a href="https://anwaltverein.de" target="_blank" class="text-gray-400 hover:text-white transition-colors flex items-center gap-1">DAV <i data-lucide="external-link" class="w-3 h-3"></i></a></li>
                        <li><a href="https://brak.de" target="_blank" class="text-gray-400 hover:text-white transition-colors flex items-center gap-1">BRAK <i data-lucide="external-link" class="w-3 h-3"></i></a></li>
                        <li><a href="https://soldan.de" target="_blank" class="text-gray-400 hover:text-white transition-colors flex items-center gap-1">Soldan Institute <i data-lucide="external-link" class="w-3 h-3"></i></a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors">Support</a></li>
                    </ul>
                </div>
            </div>

            <hr class="border-gray-600 my-6">

            <!-- Bottom Section -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-6 text-xs text-gray-500">
                    <a href="#" class="hover:text-gray-400 transition-colors">Data Protection</a>
                    <a href="#" class="hover:text-gray-400 transition-colors">Imprint</a>
                    <a href="#" class="hover:text-gray-400 transition-colors">Terms and Conditions</a>
                    <a href="#" class="hover:text-gray-400 transition-colors">Cookies</a>
                </div>
                
                <div class="flex items-center gap-2 text-xs text-gray-500">
                    <span>Powered by</span>
                    <div class="flex items-center gap-1">
                        <i data-lucide="brain" class="w-3 h-3 text-purple-400"></i>
                        <span class="text-purple-400 font-medium">Advanced AI</span>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Dashboard Management System
        class AnwaltsAIDashboard {
            constructor() {
                this.currentSection = 'dashboard';
                this.init();
            }

            init() {
                this.setupNavigation();
                this.setupMobileMenu();
                this.setupDocumentGenerator();
                this.setupEnhancedFeatures();
                this.setupEmailPortal();
                this.setupTemplatePortal();
                this.setupModals();
                this.setupKeyboardShortcuts();
                lucide.createIcons();
            }

            setupNavigation() {
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        this.switchSection(section);
                    });
                });
            }

            switchSection(section) {
                // Hide all sections
                document.querySelectorAll('.section-content').forEach(sec => {
                    sec.classList.remove('active');
                });

                // Show target section
                const targetSection = document.getElementById(section + '-section');
                if (targetSection) {
                    targetSection.classList.add('active');
                }

                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });

                const activeNavItem = document.querySelector(`[data-section="${section}"]`);
                if (activeNavItem) {
                    activeNavItem.classList.add('active');
                }

                this.currentSection = section;
                
                // Close mobile menu if open
                this.closeMobileMenu();
            }

            setupMobileMenu() {
                const mobileMenuBtn = document.getElementById('mobile-menu-btn');
                const sidebar = document.getElementById('sidebar');
                const backdrop = document.getElementById('mobile-backdrop');

                if (mobileMenuBtn && sidebar && backdrop) {
                    mobileMenuBtn.addEventListener('click', () => {
                        sidebar.classList.toggle('mobile-open');
                        backdrop.classList.toggle('hidden');
                    });

                    backdrop.addEventListener('click', () => {
                        this.closeMobileMenu();
                    });
                }
            }

            closeMobileMenu() {
                const sidebar = document.getElementById('sidebar');
                const backdrop = document.getElementById('mobile-backdrop');
                
                if (sidebar && backdrop) {
                    sidebar.classList.remove('mobile-open');
                    backdrop.classList.add('hidden');
                }
            }

            setupDocumentGenerator() {
                // File upload
                const fileInput = document.getElementById('document-upload');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                }

                // Generate button
                const generateBtn = document.getElementById('generate-document-btn');
                if (generateBtn) {
                    generateBtn.addEventListener('click', () => this.generateDocument());
                }

                // Action buttons
                this.setupActionButtons();
                
                // Quick actions
                this.setupQuickActions();
                
                // Word count tracking
                this.setupWordCount();
                
                // Enhanced features
                this.setupCountUpAnimations();
                this.setupFAB();
                this.setupAISuggestions();
                this.setupFeedbackAnimations();
                this.setupEmailPortal();
                this.setupTemplatePortal();
            }
            
            setupEnhancedFeatures() {
                // Placeholder for enhanced features setup
                // This function was called but not defined, causing JavaScript errors
                console.log('Enhanced features setup completed');
            }
            
            setupActionButtons() {
                const acceptBtn = document.getElementById('accept-btn');
                const editBtn = document.getElementById('edit-btn');
                const rejectBtn = document.getElementById('reject-btn');
                const saveBtn = document.getElementById('save-btn');
                const cancelEditBtn = document.getElementById('cancel-edit-btn');
                const downloadBtn = document.getElementById('download-btn');
                
                if (acceptBtn) {
                    acceptBtn.addEventListener('click', () => this.acceptDocument());
                }
                
                if (editBtn) {
                    editBtn.addEventListener('click', () => this.editDocument());
                }
                
                if (rejectBtn) {
                    rejectBtn.addEventListener('click', () => this.rejectDocument());
                }
                
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => this.saveDocument());
                }
                
                if (cancelEditBtn) {
                    cancelEditBtn.addEventListener('click', () => this.cancelEdit());
                }
                
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', () => this.downloadDocument());
                }
            }
            
            setupQuickActions() {
                const clearBtn = document.getElementById('clear-btn');
                const templateBtn = document.getElementById('template-btn');
                
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => this.clearAll());
                }
                
                if (templateBtn) {
                    templateBtn.addEventListener('click', () => this.loadTemplate());
                }
            }
            
            setupWordCount() {
                const contentArea = document.getElementById('document-content');
                const wordCountEl = document.getElementById('word-count');
                
                if (contentArea && wordCountEl) {
                    contentArea.addEventListener('input', () => {
                        const text = contentArea.value;
                        const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
                        wordCountEl.textContent = `${words} words`;
                    });
                }
            }

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const status = document.getElementById('upload-status');
                    const filename = document.getElementById('uploaded-filename');
                    const analysis = document.getElementById('ai-analysis');
                    
                    if (filename) filename.textContent = `${file.name} uploaded successfully`;
                    if (status) status.classList.remove('hidden');
                    
                    setTimeout(() => {
                        if (analysis) {
                            analysis.textContent = `AI analysis complete: ${file.type.includes('pdf') ? 'PDF' : 'Document'} processed - ${Math.floor(file.size / 1024)}KB analyzed`;
                        }
                    }, 2000);
                }
            }

            async generateDocument() {
                const objective = document.getElementById('doc-objective')?.value || '';
                const instructions = document.getElementById('doc-instructions')?.value || '';
                
                if (!objective && !instructions) {
                    alert('Please provide document type or instructions for the AI.');
                    return;
                }
                
                // Show loading state
                const generationStatus = document.getElementById('generation-status');
                const generateBtn = document.getElementById('generate-document-btn');
                
                if (generationStatus) generationStatus.classList.remove('hidden');
                if (generateBtn) generateBtn.disabled = true;
                
                try {
                    // Call enhanced API server for document generation
                    const authToken = localStorage.getItem('anwalts_auth_token');
                    const response = await fetch('http://localhost:5001/generate-document', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`,
                        },
                        body: JSON.stringify({
                            prompt: instructions || objective
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.document) {
                        // Convert backend response to expected format for showRealGeneratedDocument
                        const mockStats = {
                            processing_time: data.document.processing_time,
                            model_used: data.document.model_used,
                            tokens_used: data.document.tokens_used,
                            confidence: data.document.confidence
                        };
                        this.showRealGeneratedDocument(data.document.content, mockStats);
                    } else {
                        throw new Error('Document generation failed');
                    }
                    
                } catch (error) {
                    console.error('Error generating document:', error);
                    alert('Failed to generate document. Please check your connection and try again.\n\nError: ' + error.message);
                    
                    // Show fallback mock document
                    this.showGeneratedDocument(objective, instructions);
                } finally {
                    // Hide loading state
                    if (generationStatus) generationStatus.classList.add('hidden');
                    if (generateBtn) generateBtn.disabled = false;
                }
            }

            showRealGeneratedDocument(generatedContent, stats) {
                const placeholder = document.getElementById('document-placeholder');
                const editor = document.getElementById('document-editor');
                const content = document.getElementById('document-content');
                const actions = document.getElementById('document-actions');
                const wordCount = document.getElementById('word-count');
                
                // Hide placeholder, show editor
                if (placeholder) placeholder.classList.add('hidden');
                if (editor) editor.classList.remove('hidden');
                if (actions) actions.classList.remove('hidden');
                
                // Format the content for better display (preserve structure but improve readability)
                const formattedContent = this.formatLegalDocument(generatedContent);
                
                // Set the real generated content
                if (content) {
                    content.value = formattedContent;
                    content.readOnly = true;
                    
                    // Add professional document styling
                    content.style.fontFamily = "'Times New Roman', serif";
                    content.style.fontSize = '14px';
                    content.style.lineHeight = '1.6';
                    content.style.padding = '20px';
                    content.style.backgroundColor = '#ffffff';
                    content.style.border = '1px solid #e5e7eb';
                    content.style.borderRadius = '8px';
                }
                
                // Update word count
                if (wordCount && content) {
                    const words = content.value.split(/\s+/).filter(word => word.length > 0).length;
                    wordCount.textContent = `${words} words`;
                }
                
                // Show generation stats if available
                if (stats) {
                    console.log('Document Generation Stats:', stats);
                    if (stats.processing_time) {
                        console.log(`Generated in ${stats.processing_time}s`);
                    }
                }
                
                this.documentState = 'generated';
                
                // Show success notification
                this.showNotification('Document generated successfully!', 'success');
                
            }

            formatLegalDocument(rawText) {
                if (!rawText) return rawText;
                
                // Format the document to look professional while keeping it as plain text
                let formatted = rawText;
                
                // Ensure proper spacing around section headers (German legal documents)
                formatted = formatted.replace(/^(§\s*\d+.*?)$/gm, '\n$1\n');
                formatted = formatted.replace(/^([A-ZÄÖÜ][A-ZÄÖÜ\s]{5,}):?\s*$/gm, '\n$1\n');
                
                // Fix paragraph spacing
                formatted = formatted.replace(/\n{3,}/g, '\n\n');
                
                // Ensure proper indentation for sub-items
                formatted = formatted.replace(/^(\d+\.\d+)\s/gm, '    $1 ');
                formatted = formatted.replace(/^([a-z]\))\s/gm, '      $1 ');
                
                // Clean up any remaining markdown that might have slipped through
                formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '$1');
                formatted = formatted.replace(/\*([^*]+)\*/g, '$1');
                formatted = formatted.replace(/^#{1,6}\s*/gm, '');
                
                return formatted.trim();
            }


            showGeneratedDocument(objective, instructions) {
                const placeholder = document.getElementById('document-placeholder');
                const editor = document.getElementById('document-editor');
                const content = document.getElementById('document-content');
                const actions = document.getElementById('document-actions');
                const wordCount = document.getElementById('word-count');
                
                // Hide placeholder, show editor
                if (placeholder) placeholder.classList.add('hidden');
                if (editor) editor.classList.remove('hidden');
                if (actions) actions.classList.remove('hidden');
                
                // Generate sample document content
                const sampleDocument = `${objective || 'LEGAL DOCUMENT'}

Generated by AI based on your instructions:
"${instructions || 'No specific instructions provided'}"

DOCUMENT CONTENT

This is a professionally generated legal document created by AI based on your specific requirements. The AI has analyzed your instructions and created a comprehensive document that addresses your needs.

KEY PROVISIONS:
• All parties and their responsibilities clearly defined
• Terms and conditions based on current legal standards  
• Compliance with applicable laws and regulations
• Clear dispute resolution mechanisms

TERMS AND CONDITIONS

1. Scope of Agreement
   This document establishes the framework for the legal relationship between the parties as specified in your instructions.

2. Responsibilities and Obligations
   Each party shall fulfill their obligations as outlined in this agreement and in accordance with applicable law.

3. Duration and Termination
   This agreement shall remain in effect as specified and may be terminated under the conditions outlined herein.

4. Dispute Resolution
   Any disputes arising from this agreement shall be resolved through appropriate legal channels.

NOTE: This document has been generated by AI and should be reviewed by a qualified legal professional before use.

Generated on: ${new Date().toLocaleDateString()}
Document ID: DOC-${Date.now()}`;
                
                if (content) {
                    content.value = sampleDocument;
                    content.style.height = 'auto';
                    content.style.height = content.scrollHeight + 'px';
                    
                    // Update word count
                    const words = sampleDocument.trim().split(/\s+/).filter(word => word.length > 0).length;
                    if (wordCount) wordCount.textContent = `${words} words`;
                }
                
                this.documentState = 'generated';
            }
            
            acceptDocument() {
                alert('Document accepted! Ready for download or further processing.');
                this.documentState = 'accepted';
                
                // Show download options or save to templates
                const actions = document.getElementById('document-actions');
                const editActions = document.getElementById('edit-actions');
                
                if (actions) actions.classList.add('hidden');
                if (editActions) {
                    editActions.classList.remove('hidden');
                    // Change save button to "Save as Final"
                    const saveBtn = document.getElementById('save-btn');
                    if (saveBtn) {
                        saveBtn.innerHTML = '<i data-lucide="check" class="w-5 h-5"></i>Save as Final';
                        saveBtn.className = saveBtn.className.replace('from-green-500 to-green-600', 'from-emerald-500 to-emerald-600');
                    }
                }
            }
            
            editDocument() {
                const content = document.getElementById('document-content');
                const actions = document.getElementById('document-actions');
                const editActions = document.getElementById('edit-actions');
                
                if (content) {
                    content.readOnly = false;
                    content.focus();
                    content.style.backgroundColor = '#fff';
                    content.style.border = '2px solid #8b5cf6';
                }
                
                if (actions) actions.classList.add('hidden');
                if (editActions) editActions.classList.remove('hidden');
                
                this.documentState = 'editing';
                this.originalContent = content?.value || '';
            }
            
            rejectDocument() {
                if (confirm('Are you sure you want to reject this document? You can regenerate a new version.')) {
                    const placeholder = document.getElementById('document-placeholder');
                    const editor = document.getElementById('document-editor');
                    const actions = document.getElementById('document-actions');
                    const editActions = document.getElementById('edit-actions');
                    
                    // Reset to placeholder state
                    if (placeholder) placeholder.classList.remove('hidden');
                    if (editor) editor.classList.add('hidden');
                    if (actions) actions.classList.add('hidden');
                    if (editActions) editActions.classList.add('hidden');
                    
                    this.documentState = 'empty';
                }
            }
            
            saveDocument() {
                const content = document.getElementById('document-content');
                const wordCount = document.getElementById('word-count');
                
                if (content) {
                    content.readOnly = true;
                    content.style.border = 'none';
                    
                    // Update word count
                    const words = content.value.trim().split(/\s+/).filter(word => word.length > 0).length;
                    if (wordCount) wordCount.textContent = `${words} words`;
                }
                
                const actions = document.getElementById('document-actions');
                const editActions = document.getElementById('edit-actions');
                
                if (actions) actions.classList.remove('hidden');
                if (editActions) editActions.classList.add('hidden');
                
                this.documentState = 'saved';
                
                // Show success message
                const originalText = document.getElementById('save-btn')?.textContent;
                const saveBtn = document.getElementById('save-btn');
                if (saveBtn) {
                    saveBtn.innerHTML = '<i data-lucide="check" class="w-5 h-5"></i>Saved!';
                    setTimeout(() => {
                        saveBtn.innerHTML = '<i data-lucide="save" class="w-5 h-5"></i>Save Changes';
                    }, 2000);
                }
            }
            
            cancelEdit() {
                const content = document.getElementById('document-content');
                const actions = document.getElementById('document-actions');
                const editActions = document.getElementById('edit-actions');
                
                if (content && this.originalContent) {
                    content.value = this.originalContent;
                    content.readOnly = true;
                    content.style.border = 'none';
                }
                
                if (actions) actions.classList.remove('hidden');
                if (editActions) editActions.classList.add('hidden');
                
                this.documentState = 'generated';
            }
            
            downloadDocument() {
                try {
                    this.showNotification('Generiere europäisches Standard-PDF...', 'info');
                    
                    // Get the document content from the textarea
                    const documentContent = document.getElementById('document-content');
                    if (!documentContent || !documentContent.value) {
                        throw new Error('Kein Dokumenteninhalt verfügbar');
                    }
                    
                    const content = documentContent.value;
                    const { jsPDF } = window.jspdf;
                    
                    // Create PDF with European A4 standards (210 × 297 mm)
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4',
                        putOnlyUsedFonts: true
                    });
                    
                    // European A4 dimensions and margins
                    const pageWidth = 210;
                    const pageHeight = 297;
                    const marginLeft = 25;
                    const marginRight = 25;
                    const marginTop = 30;
                    const marginBottom = 25;
                    const contentWidth = pageWidth - marginLeft - marginRight;
                    
                    // Set font for German legal documents
                    pdf.setFont('helvetica', 'normal');
                    
                    // Split content into lines that fit the page width
                    const fontSize = 11;
                    pdf.setFontSize(fontSize);
                    const lineHeight = 6;
                    
                    // Split text into lines
                    const lines = pdf.splitTextToSize(content, contentWidth);
                    
                    let currentY = marginTop + 20; // Start below header
                    let pageNumber = 1;
                    
                    // Add first page header
                    this.addPDFHeader(pdf, pageNumber, pageWidth, marginLeft, marginRight);
                    
                    // Add content line by line
                    for (let i = 0; i < lines.length; i++) {
                        // Check if we need a new page
                        if (currentY + lineHeight > pageHeight - marginBottom) {
                            // Add footer with page number
                            this.addPDFFooter(pdf, pageNumber, pageWidth, pageHeight, marginBottom);
                            
                            // Add new page
                            pdf.addPage();
                            pageNumber++;
                            currentY = marginTop + 20; // Reset Y position for new page
                            
                            // Add header to new page
                            this.addPDFHeader(pdf, pageNumber, pageWidth, marginLeft, marginRight);
                        }
                        
                        // Add line to PDF
                        pdf.text(lines[i], marginLeft, currentY);
                        currentY += lineHeight;
                    }
                    
                    // Add footer to last page
                    this.addPDFFooter(pdf, pageNumber, pageWidth, pageHeight, marginBottom);
                    
                    // Generate filename with timestamp
                    const timestamp = new Date().toISOString().split('T')[0];
                    const filename = `AnwaltsAI_Rechtsdokument_${timestamp}.pdf`;
                    
                    // Download the PDF
                    pdf.save(filename);
                    
                    this.showNotification('PDF erfolgreich generiert und heruntergeladen!', 'success');
                    
                } catch (error) {
                    console.error('PDF generation failed:', error);
                    this.showNotification('PDF-Generierung fehlgeschlagen: ' + error.message, 'error');
                }
            }
            
            addPDFHeader(pdf, pageNumber, pageWidth, marginLeft, marginRight) {
                // Add header with Lawyer AI and legal symbol
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                
                // Legal symbol (§) and "Lawyer AI" in center, italicized
                const headerText = '§ Lawyer AI';
                const textWidth = pdf.getTextWidth(headerText);
                const centerX = pageWidth / 2;
                
                // Draw header
                pdf.setFont('helvetica', 'italic');
                pdf.text(headerText, centerX - (textWidth / 2), 15);
                
                // Add horizontal line under header
                pdf.setLineWidth(0.5);
                pdf.line(marginLeft, 20, pageWidth - marginRight, 20);
                
                // Reset font
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(11);
            }
            
            addPDFFooter(pdf, pageNumber, pageWidth, pageHeight, marginBottom) {
                // Add page number at bottom center
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                
                const footerText = `Seite ${pageNumber}`;
                const textWidth = pdf.getTextWidth(footerText);
                const centerX = pageWidth / 2;
                
                // Add horizontal line above footer
                pdf.setLineWidth(0.3);
                pdf.line(25, pageHeight - marginBottom + 5, pageWidth - 25, pageHeight - marginBottom + 5);
                
                // Add page number
                pdf.text(footerText, centerX - (textWidth / 2), pageHeight - marginBottom + 12);
            }
            
            clearAll() {
                if (confirm('Clear all content and start over?')) {
                    // Clear inputs
                    const objective = document.getElementById('doc-objective');
                    const instructions = document.getElementById('doc-instructions');
                    const fileInput = document.getElementById('document-upload');
                    const uploadStatus = document.getElementById('upload-status');
                    
                    if (objective) objective.value = '';
                    if (instructions) instructions.value = '';
                    if (fileInput) fileInput.value = '';
                    if (uploadStatus) uploadStatus.classList.add('hidden');
                    
                    // Reset document area
                    this.rejectDocument();
                }
            }
            
            loadTemplate() {
                alert('Template loading feature coming soon! This will allow you to load pre-made document templates.');
            }
            
            // Enhanced Features
            setupCountUpAnimations() {
                const statNumbers = document.querySelectorAll('.stat-number');
                const animateNumber = (element, target, duration = 2000) => {
                    const start = 0;
                    const increment = target / (duration / 16);
                    let current = start;
                    
                    const timer = setInterval(() => {
                        current += increment;
                        if (current >= target) {
                            current = target;
                            clearInterval(timer);
                        }
                        element.textContent = Math.floor(current);
                    }, 16);
                };
                
                // Trigger animations when dashboard is loaded
                setTimeout(() => {
                    statNumbers.forEach(element => {
                        const target = parseInt(element.dataset.target);
                        animateNumber(element, target);
                    });
                }, 500);
            }
            
            setupFAB() {
                const fabButton = document.getElementById('fab-button');
                const fabMenu = document.getElementById('fab-menu');
                let isOpen = false;
                
                if (fabButton && fabMenu) {
                    fabButton.addEventListener('click', () => {
                        isOpen = !isOpen;
                        fabMenu.classList.toggle('open', isOpen);
                        
                        // Rotate FAB icon
                        const icon = fabButton.querySelector('i');
                        if (icon) {
                            icon.style.transform = isOpen ? 'rotate(45deg)' : 'rotate(0deg)';
                        }
                    });
                    
                    // Close FAB menu when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!fabButton.contains(e.target) && !fabMenu.contains(e.target) && isOpen) {
                            isOpen = false;
                            fabMenu.classList.remove('open');
                            const icon = fabButton.querySelector('i');
                            if (icon) icon.style.transform = 'rotate(0deg)';
                        }
                    });
                }
            }
            
            setupAISuggestions() {
                const aiSuggestions = document.getElementById('ai-suggestions');
                let isOpen = false;
                this.aiSuggestionsState = {
                    dismissed: new Set(),
                    pinned: new Set(),
                    applied: new Set(['2']), // Mock: suggestion 2 is already applied
                    refreshTimer: null
                };
                
                // Auto-show suggestions after 3 seconds
                setTimeout(() => {
                    if (aiSuggestions) {
                        aiSuggestions.classList.add('open');
                        isOpen = true;
                        this.startRefreshCountdown();
                        
                        // Auto-hide after 10 seconds unless pinned
                        setTimeout(() => {
                            if (this.aiSuggestionsState.pinned.size === 0) {
                                aiSuggestions.classList.remove('open');
                                isOpen = false;
                            }
                        }, 10000);
                    }
                }, 3000);
                
                // Close button
                const closeBtn = document.getElementById('close-ai-suggestions');
                if (closeBtn) {
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        aiSuggestions.classList.remove('open');
                        isOpen = false;
                    });
                }
                
                // Refresh button
                const refreshBtn = document.getElementById('refresh-suggestions');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.refreshAISuggestions();
                    });
                }
                
                // Toggle on panel click (but not on buttons)
                if (aiSuggestions) {
                    aiSuggestions.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            isOpen = !isOpen;
                            aiSuggestions.classList.toggle('open', isOpen);
                        }
                    });
                }
                
                // Setup suggestion interactions
                this.setupSuggestionInteractions();
            }
            
            setupSuggestionInteractions() {
                // Dismiss buttons
                const dismissButtons = document.querySelectorAll('.dismiss-suggestion');
                dismissButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const suggestionId = btn.dataset.suggestionId;
                        this.dismissSuggestion(suggestionId);
                    });
                });
                
                // Pin buttons
                const pinButtons = document.querySelectorAll('.pin-suggestion');
                pinButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const suggestionId = btn.dataset.suggestionId;
                        this.togglePinSuggestion(suggestionId);
                    });
                });
                
                // Suggestion items (apply on click)
                const suggestionItems = document.querySelectorAll('.ai-suggestion-item');
                suggestionItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            const suggestionId = item.dataset.suggestionId;
                            this.applySuggestion(suggestionId);
                        }
                    });
                });
            }
            
            dismissSuggestion(suggestionId) {
                const suggestion = document.querySelector(`[data-suggestion-id="${suggestionId}"]`);
                if (suggestion) {
                    this.aiSuggestionsState.dismissed.add(suggestionId);
                    suggestion.style.opacity = '0';
                    suggestion.style.transform = 'translateX(100%)';
                    
                    setTimeout(() => {
                        suggestion.remove();
                        this.showNotification('Suggestion dismissed', 'info');
                        
                        // If no suggestions left, hide panel
                        const remaining = document.querySelectorAll('.ai-suggestion-item').length;
                        if (remaining === 0) {
                            document.getElementById('ai-suggestions').classList.remove('open');
                        }
                    }, 300);
                }
            }
            
            togglePinSuggestion(suggestionId) {
                const pinBtn = document.querySelector(`.pin-suggestion[data-suggestion-id="${suggestionId}"]`);
                if (pinBtn) {
                    if (this.aiSuggestionsState.pinned.has(suggestionId)) {
                        this.aiSuggestionsState.pinned.delete(suggestionId);
                        pinBtn.classList.remove('pinned');
                        pinBtn.title = 'Pin suggestion';
                        pinBtn.querySelector('i').className = 'w-3 h-3 text-gray-500 hover:text-yellow-400';
                        this.showNotification('Suggestion unpinned', 'info');
                    } else {
                        this.aiSuggestionsState.pinned.add(suggestionId);
                        pinBtn.classList.add('pinned');
                        pinBtn.title = 'Unpin suggestion';
                        pinBtn.querySelector('i').className = 'w-3 h-3 text-yellow-400';
                        this.showNotification('Suggestion pinned', 'info');
                    }
                }
            }
            
            applySuggestion(suggestionId) {
                if (this.aiSuggestionsState.applied.has(suggestionId)) {
                    return; // Already applied
                }
                
                const suggestion = document.querySelector(`[data-suggestion-id="${suggestionId}"]`);
                if (suggestion) {
                    this.aiSuggestionsState.applied.add(suggestionId);
                    suggestion.classList.add('applied');
                    
                    // Add "Used" badge
                    const titleElement = suggestion.querySelector('.text-sm.font-medium');
                    if (titleElement && !titleElement.querySelector('.bg-green-500\\/20')) {
                        const usedBadge = document.createElement('span');
                        usedBadge.className = 'text-xs px-2 py-0.5 bg-green-500/20 text-green-400 rounded-full';
                        usedBadge.textContent = 'Used';
                        titleElement.appendChild(usedBadge);
                    }
                    
                    // Mock actions based on suggestion type
                    const suggestionText = suggestion.querySelector('.text-xs.text-gray-400').textContent;
                    if (suggestionText.includes('Mahnung')) {
                        this.switchSection('templates');
                        this.showNotification('Navigated to popular Mahnung templates', 'success');
                    } else if (suggestionText.includes('contract')) {
                        this.switchSection('generator');
                        this.showNotification('Document generator opened with contract template', 'success');
                    } else if (suggestionText.includes('bulk email')) {
                        this.switchSection('emails');
                        this.showNotification('Email portal opened with bulk processing tips', 'success');
                    }
                }
            }
            
            refreshAISuggestions() {
                const refreshBtn = document.getElementById('refresh-suggestions');
                const originalText = refreshBtn.textContent;
                
                refreshBtn.textContent = 'Refreshing...';
                refreshBtn.disabled = true;
                
                setTimeout(() => {
                    refreshBtn.textContent = originalText;
                    refreshBtn.disabled = false;
                    this.startRefreshCountdown();
                    this.showNotification('AI suggestions refreshed', 'success');
                }, 2000);
            }
            
            startRefreshCountdown() {
                if (this.aiSuggestionsState.refreshTimer) {
                    clearInterval(this.aiSuggestionsState.refreshTimer);
                }
                
                let hours = 12;
                const countdownElement = document.getElementById('suggestion-countdown');
                
                this.aiSuggestionsState.refreshTimer = setInterval(() => {
                    hours -= 0.1; // Simulate faster countdown for demo
                    if (hours <= 0) {
                        this.refreshAISuggestions();
                        return;
                    }
                    
                    if (countdownElement) {
                        if (hours >= 1) {
                            countdownElement.textContent = `${Math.ceil(hours)}h`;
                        } else {
                            countdownElement.textContent = `${Math.ceil(hours * 60)}m`;
                        }
                    }
                }, 60000); // Update every minute (or faster for demo)
            }
            
            setupFeedbackAnimations() {
                // Enhanced feedback for accept/reject buttons
                const acceptBtn = document.getElementById('accept-btn');
                const rejectBtn = document.getElementById('reject-btn');
                
                if (acceptBtn) {
                    acceptBtn.addEventListener('click', (e) => {
                        e.target.classList.add('success-pulse');
                        setTimeout(() => e.target.classList.remove('success-pulse'), 600);
                    });
                }
                
                if (rejectBtn) {
                    rejectBtn.addEventListener('click', (e) => {
                        e.target.classList.add('reject-shake');
                        setTimeout(() => e.target.classList.remove('reject-shake'), 500);
                    });
                }
            }
            
            setupEmailPortal() {
                // Email row click handlers
                this.setupEmailRowHandlers();
                this.setupEmailPreviewPane();
                this.setupFilterTags();
                this.setupEmailAnimations();
                this.setupAttachmentHandlers();
            }
            
            setupEmailRowHandlers() {
                const emailRows = document.querySelectorAll('.email-row');
                emailRows.forEach(row => {
                    row.addEventListener('click', (e) => {
                        // Don't trigger if clicking on action buttons
                        if (e.target.closest('button')) return;
                        
                        const emailId = row.dataset.emailId;
                        this.showEmailPreview(emailId);
                    });
                });
            }
            
            setupEmailPreviewPane() {
                const previewPane = document.getElementById('email-preview-pane');
                const closeBtn = document.getElementById('close-preview');
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        previewPane.classList.remove('open');
                    });
                }
                
                // AI suggestion buttons
                const aiButtons = document.querySelectorAll('.ai-suggest-btn');
                aiButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.generateAIResponse(btn);
                    });
                });
                
                // Convert to document buttons
                const convertButtons = document.querySelectorAll('.convert-cta');
                convertButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.convertEmailToDocument(btn);
                    });
                });
            }
            
            setupFilterTags() {
                const filterTags = document.querySelectorAll('.filter-tag');
                filterTags.forEach(tag => {
                    tag.addEventListener('click', () => {
                        // Remove active from all tags
                        filterTags.forEach(t => t.classList.remove('active'));
                        // Add active to clicked tag
                        tag.classList.add('active');
                        
                        const filter = tag.dataset.filter;
                        this.filterEmails(filter);
                    });
                });
            }
            
            setupEmailAnimations() {
                // Animate email rows on load
                const emailRows = document.querySelectorAll('.email-row');
                emailRows.forEach((row, index) => {
                    setTimeout(() => {
                        row.style.animationDelay = `${index * 0.1}s`;
                    }, 100);
                });
            }
            
            setupAttachmentHandlers() {
                const attachmentItems = document.querySelectorAll('.attachment-item');
                attachmentItems.forEach(item => {
                    item.addEventListener('click', () => {
                        this.openAttachmentModal(item);
                    });
                });
            }
            
            showEmailPreview(emailId) {
                const previewPane = document.getElementById('email-preview-pane');
                const emailHeader = document.getElementById('email-header');
                const emailContent = document.getElementById('email-content');
                const attachmentSection = document.getElementById('attachment-section');
                const threadTimeline = document.getElementById('thread-timeline');
                
                // Show preview pane
                previewPane.classList.add('open');
                
                // Show loading skeleton
                this.showLoadingSkeleton();
                
                // Simulate loading delay
                setTimeout(() => {
                    this.populateEmailPreview(emailId);
                }, 800);
            }
            
            showLoadingSkeleton() {
                const emailHeader = document.getElementById('email-header');
                const emailContent = document.getElementById('email-content');
                
                emailHeader.innerHTML = `
                    <div class="skeleton-loader h-6 w-3/4 mb-2"></div>
                    <div class="skeleton-loader h-4 w-1/2 mb-4"></div>
                    <div class="skeleton-loader h-4 w-full mb-2"></div>
                    <div class="skeleton-loader h-4 w-2/3"></div>
                `;
                
                emailContent.innerHTML = `
                    <div class="skeleton-loader h-4 w-full mb-2"></div>
                    <div class="skeleton-loader h-4 w-full mb-2"></div>
                    <div class="skeleton-loader h-4 w-3/4 mb-2"></div>
                    <div class="skeleton-loader h-4 w-full mb-2"></div>
                    <div class="skeleton-loader h-4 w-2/3"></div>
                `;
            }
            
            populateEmailPreview(emailId) {
                const emailHeader = document.getElementById('email-header');
                const emailContent = document.getElementById('email-content');
                const attachmentSection = document.getElementById('attachment-section');
                const threadTimeline = document.getElementById('thread-timeline');
                
                // Mock email data
                const emailData = {
                    '1': {
                        subject: 'Anfrage Kaufvertrag Immobilie',
                        from: 'Max Mustermann <client@example.com>',
                        date: '31.07.2025, 14:30',
                        content: `Sehr geehrte Damen und Herren,
                        
ich benötige Unterstützung beim Kauf einer <span class="legal-term">Immobilie</span> in München. Es handelt sich um eine Eigentumswohnung im Wert von 450.000 Euro.

Könnten Sie mir einen <span class="legal-term">Kaufvertrag</span> erstellen und die rechtlichen Aspekte prüfen? Besonders wichtig sind mir die <span class="legal-term">Gewährleistungsklauseln</span> und die <span class="legal-term">Finanzierungsvereinbarungen</span>.

Die <span class="legal-term">Frist</span> für die Vertragsunterzeichnung ist der 15. August 2025.

Mit freundlichen Grüßen
Max Mustermann`,
                        hasAttachments: true,
                        hasThread: true
                    },
                    '2': {
                        subject: 'Mandantenvertretung - Herr Schmidt',
                        from: 'Kollege Schmidt <partner@lawfirm.de>',
                        date: '31.07.2025, 11:15',
                        content: `Liebe Kollegin,
                        
bezüglich des <span class="legal-term">Mandats</span> von Herrn Schmidt möchte ich Sie über den aktuellen Stand informieren.

Die Verhandlungen mit der Gegenseite verlaufen positiv. Ein <span class="legal-term">Vergleichsvorschlag</span> liegt vor.

Bitte prüfen Sie die beigefügten Unterlagen und geben Sie mir Bescheid.

Beste Grüße
Kollege Schmidt`,
                        hasAttachments: false,
                        hasThread: false
                    }
                };
                
                const email = emailData[emailId] || emailData['1'];
                
                // Populate header
                emailHeader.innerHTML = `
                    <h4 class="text-lg font-semibold text-white mb-2">${email.subject}</h4>
                    <p class="text-sm text-gray-400 mb-4">From: ${email.from}</p>
                    <p class="text-sm text-gray-400">Date: ${email.date}</p>
                `;
                
                // Populate content
                emailContent.innerHTML = `
                    <div class="prose prose-invert max-w-none">
                        <div class="text-sm text-gray-300 leading-relaxed whitespace-pre-line serif-text">
                            ${email.content}
                        </div>
                    </div>
                `;
                
                // Show/hide attachments
                if (email.hasAttachments) {
                    attachmentSection.style.display = 'block';
                }
                
                // Show/hide thread
                if (email.hasThread) {
                    threadTimeline.style.display = 'block';
                }
            }
            
            generateAIResponse(button) {
                button.classList.add('processing');
                const originalContent = button.innerHTML;
                
                button.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                        Generating...
                    </div>
                `;
                
                setTimeout(() => {
                    button.classList.remove('processing');
                    button.innerHTML = `
                        <i data-lucide="check" class="w-4 h-4"></i>
                        AI Response Ready
                    `;
                    button.classList.remove('bg-purple-600');
                    button.classList.add('bg-green-600');
                    
                    // Show notification
                    this.showNotification('AI response generated successfully!', 'success');
                }, 3000);
            }
            
            convertEmailToDocument(button) {
                button.classList.add('converting');
                
                setTimeout(() => {
                    this.switchSection('generator');
                    this.showNotification('Email converted to document template!', 'success');
                }, 800);
            }
            
            filterEmails(filter) {
                const emailRows = document.querySelectorAll('.email-row');
                
                emailRows.forEach(row => {
                    row.style.display = 'none';
                    row.style.opacity = '0';
                });
                
                // Show filtered emails with animation
                setTimeout(() => {
                    emailRows.forEach((row, index) => {
                        if (filter === 'all' || this.emailMatchesFilter(row, filter)) {
                            row.style.display = 'grid';
                            setTimeout(() => {
                                row.style.opacity = '1';
                                row.style.transform = 'translateY(0)';
                            }, index * 100);
                        }
                    });
                }, 200);
            }
            
            emailMatchesFilter(row, filter) {
                // Mock filter logic - in real app, this would check email data
                const emailId = row.dataset.emailId;
                const mockFilters = {
                    'unread': ['1', '3'],
                    'mahnung': [],
                    'vertrag': ['1'],
                    'kuendigung': [],
                    'ai-pending': ['1', '3']
                };
                
                return mockFilters[filter]?.includes(emailId) || false;
            }
            
            openAttachmentModal(item) {
                // Mock attachment modal
                alert('Opening attachment viewer...\n\nIn a real implementation, this would open a full-screen PDF viewer or image gallery.');
            }
            
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
                    type === 'success' ? 'bg-green-600' : 'bg-blue-600'
                }`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
            
            setupTemplatePortal() {
                // Setup template card interactions
                this.setupTemplateCards();
                this.setupTemplateFilters();
                this.setupImportExport();
                this.setupTemplateAnalytics();
                this.setupClauseLibrary();
            }
            
            setupTemplateCards() {
                const templateCards = document.querySelectorAll('.template-card');
                templateCards.forEach((card, index) => {
                    const templateId = card.dataset.templateId || String(index + 1);
                    
                    // Fix placeholder template IDs in buttons
                    const useBtn = card.querySelector('.use-template-btn');
                    const duplicateBtn = card.querySelector('.duplicate-template-btn');
                    
                    if (useBtn) {
                        useBtn.dataset.templateId = templateId;
                        useBtn.dataset.testid = `use-template-${templateId}`;
                        useBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.useTemplate(templateId);
                        });
                    }
                    
                    if (duplicateBtn) {
                        duplicateBtn.dataset.templateId = templateId;
                        duplicateBtn.dataset.testid = `duplicate-template-${templateId}`;
                        duplicateBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.duplicateTemplate(templateId);
                        });
                    }
                    
                    // Edit template button
                    const editBtn = card.querySelector('.edit-template-btn');
                    if (editBtn) {
                        editBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.editTemplate(templateId);
                        });
                    }
                    
                    // Template stats interaction
                    const statsBtn = card.querySelector('.template-stats-btn');
                    if (statsBtn) {
                        statsBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.showTemplateAnalytics(templateId);
                        });
                    }
                });
            }
            
            
            setupTemplateFilters() {
                const filterSidebar = document.getElementById('template-filter-sidebar');
                const filterToggle = document.getElementById('filter-toggle');
                const searchInput = document.getElementById('template-search');
                const categoryFilters = document.querySelectorAll('.category-filter');
                const typeFilters = document.querySelectorAll('.type-filter');
                
                // Toggle filter sidebar
                if (filterToggle && filterSidebar) {
                    filterToggle.addEventListener('click', () => {
                        filterSidebar.classList.toggle('open');
                    });
                }
                
                // Search functionality
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.filterTemplates({ search: e.target.value });
                    });
                }
                
                // Category filters
                categoryFilters.forEach(filter => {
                    filter.addEventListener('click', () => {
                        // Toggle active state
                        filter.classList.toggle('active');
                        this.updateTemplateFilters();
                    });
                });
                
                // Type filters
                typeFilters.forEach(filter => {
                    filter.addEventListener('click', () => {
                        filter.classList.toggle('active');
                        this.updateTemplateFilters();
                    });
                });
                
                // Clear filters
                const clearFilters = document.getElementById('clear-filters');
                if (clearFilters) {
                    clearFilters.addEventListener('click', () => {
                        categoryFilters.forEach(f => f.classList.remove('active'));
                        typeFilters.forEach(f => f.classList.remove('active'));
                        if (searchInput) searchInput.value = '';
                        this.filterTemplates({});
                    });
                }
            }
            
            setupImportExport() {
                const importBtn = document.getElementById('import-templates-btn');
                const exportBtn = document.getElementById('export-templates-btn');
                const importDialog = document.getElementById('import-export-modal');
                const closeDialog = document.getElementById('close-import-dialog');
                const dropZone = document.getElementById('template-drop-zone');
                const fileInput = document.getElementById('template-file-input');
                
                // Import button
                if (importBtn && importDialog) {
                    importBtn.addEventListener('click', () => {
                        importDialog.classList.add('open');
                    });
                }
                
                // Export button
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        this.exportTemplates();
                    });
                }
                
                // Close dialog
                if (closeDialog && importDialog) {
                    closeDialog.addEventListener('click', () => {
                        importDialog.classList.remove('open');
                    });
                }
                
                // Drag and drop functionality
                if (dropZone && fileInput) {
                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZone.classList.add('drag-active');
                    });
                    
                    dropZone.addEventListener('dragleave', () => {
                        dropZone.classList.remove('drag-active');
                    });
                    
                    dropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropZone.classList.remove('drag-active');
                        const files = e.dataTransfer.files;
                        this.handleTemplateFiles(files);
                    });
                    
                    dropZone.addEventListener('click', () => {
                        fileInput.click();
                    });
                    
                    fileInput.addEventListener('change', (e) => {
                        this.handleTemplateFiles(e.target.files);
                    });
                }
                
                // Setup export format buttons
                const exportButtons = document.querySelectorAll('.export-format-btn');
                exportButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const format = btn.dataset.format;
                        this.exportTemplates(format);
                        this.closeModal('import-modal');
                    });
                });
            }
            
            setupTemplateAnalytics() {
                // Setup chart animations and interactions
                const analyticsCards = document.querySelectorAll('.analytics-card');
                analyticsCards.forEach(card => {
                    const chart = card.querySelector('.usage-chart');
                    if (chart) {
                        this.animateChart(chart);
                    }
                });
            }
            
            setupClauseLibrary() {
                const clauseItems = document.querySelectorAll('.clause-item');
                clauseItems.forEach(item => {
                    const copyBtn = item.querySelector('.copy-clause-btn');
                    if (copyBtn) {
                        copyBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.copyClauseToClipboard(item);
                        });
                    }
                });
            }
            
            // Template action methods
            useTemplate(templateId) {
                this.showNotification('Template wird geladen...', 'info');
                
                // Get template data
                const templateData = this.getTemplateData(templateId);
                
                // Switch to document generator
                this.switchSection('generator');
                
                // Simulate loading template content
                setTimeout(() => {
                    const instructions = document.getElementById('doc-instructions');
                    const objective = document.getElementById('doc-objective');
                    
                    if (instructions && templateData) {
                        instructions.value = templateData.content;
                        // Auto-resize textarea
                        instructions.style.height = 'auto';
                        instructions.style.height = instructions.scrollHeight + 'px';
                    }
                    
                    if (objective && templateData) {
                        objective.value = `${templateData.name} - Neues Dokument erstellen`;
                    }
                    
                    // Update document state
                    this.documentState = 'template-loaded';
                    
                    this.showNotification(`Template "${templateData?.name || templateId}" erfolgreich geladen!`, 'success');
                }, 1000);
            }
            
            getTemplateData(templateId) {
                // Mock template data - in real app, this would fetch from backend
                const templates = {
                    '1': {
                        name: 'Mahnung (1. Stufe)',
                        content: 'Sehr geehrte Damen und Herren,\n\nhiermit mahnen wir Sie zur Zahlung der offenen Rechnung Nr. [RECHNUNGSNUMMER] vom [DATUM] über [BETRAG] €.\n\nWir bitten Sie, den Betrag innerhalb von 14 Tagen zu begleichen.\n\nMit freundlichen Grüßen\n[KANZLEI_NAME]',
                        category: 'payment'
                    },
                    '2': {
                        name: 'Geheimhaltungsvereinbarung',
                        content: 'GEHEIMHALTUNGSVEREINBARUNG\n\nZwischen [PARTEI_1] und [PARTEI_2] wird folgende Geheimhaltungsvereinbarung geschlossen:\n\n1. Gegenstand\nDie Parteien beabsichtigen...\n\n2. Vertrauliche Informationen\n...\n\n3. Verpflichtungen\n...',
                        category: 'contracts'
                    },
                    '3': {
                        name: 'Kündigung Arbeitsvertrag',
                        content: 'Sehr geehrte/r [NAME],\n\nhiermit kündigen wir das mit Ihnen bestehende Arbeitsverhältnis ordentlich zum [DATUM].\n\nDie Kündigungsfrist beträgt gemäß [GRUNDLAGE] ...\n\nWir danken Ihnen für Ihre Mitarbeit.\n\nMit freundlichen Grüßen\n[ARBEITGEBER]',
                        category: 'employment'
                    },
                    '4': {
                        name: 'Kaufvertrag Immobilie',
                        content: 'KAUFVERTRAG\n\nZwischen [KÄUFER_NAME] und [VERKÄUFER_NAME] wird folgender Kaufvertrag geschlossen:\n\nObjekt: [IMMOBILIE_ADRESSE]\nKaufpreis: [BETRAG] €\n\n§ 1 Vertragsgegenstand\n...\n\n§ 2 Kaufpreis\n...',
                        category: 'real-estate'
                    }
                };
                
                return templates[templateId] || templates['1'];
            }
            
            editTemplate(templateId) {
                this.showNotification('Template-Editor wird geöffnet...', 'info');
                // In real implementation, this would open a template editor modal
            }
            
            duplicateTemplate(templateId) {
                const templateData = this.getTemplateData(templateId);
                this.showNotification(`Template "${templateData.name}" wird dupliziert...`, 'info');
                
                // Simulate duplication process
                setTimeout(() => {
                    this.showNotification(`Template "${templateData.name}" erfolgreich dupliziert!`, 'success');
                    // In real implementation, would add new card to grid or refresh
                }, 1500);
            }
            
            showTemplateAnalytics(templateId) {
                this.showNotification('Analytics werden geladen...', 'info');
                // In real implementation, this would show detailed analytics
            }
            
            createNewTemplate() {
                this.showNotification('Template-Creator wird geöffnet...', 'info');
                // In real implementation, this would open template creation modal
            }
            
            openImportDialog() {
                const importDialog = document.getElementById('import-export-modal');
                if (importDialog) {
                    importDialog.classList.add('open');
                }
            }
            
            generateAITemplate() {
                this.showNotification('KI-Template wird generiert...', 'info');
                // In real implementation, this would generate AI-powered template
            }
            
            filterTemplates(filters) {
                const templateCards = document.querySelectorAll('.template-card');
                
                templateCards.forEach(card => {
                    let visible = true;
                    
                    // Search filter
                    if (filters.search) {
                        const title = card.querySelector('.template-title')?.textContent.toLowerCase();
                        const description = card.querySelector('.template-description')?.textContent.toLowerCase();
                        const searchTerm = filters.search.toLowerCase();
                        
                        visible = visible && (title?.includes(searchTerm) || description?.includes(searchTerm));
                    }
                    
                    // Category and type filters would be implemented here
                    
                    // Apply visibility
                    if (visible) {
                        card.style.display = 'block';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0) scale(1)';
                    } else {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(20px) scale(0.95)';
                        setTimeout(() => {
                            if (card.style.opacity === '0') {
                                card.style.display = 'none';
                            }
                        }, 300);
                    }
                });
            }
            
            updateTemplateFilters() {
                const activeCategories = Array.from(document.querySelectorAll('.category-filter.active'))
                    .map(f => f.dataset.category);
                const activeTypes = Array.from(document.querySelectorAll('.type-filter.active'))
                    .map(f => f.dataset.type);
                
                // Apply filters based on active selections
                this.filterTemplates({
                    categories: activeCategories,
                    types: activeTypes
                });
            }
            
            handleTemplateFiles(files) {
                Array.from(files).forEach(file => {
                    if (file.type === 'application/json' || file.name.endsWith('.json')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const templates = JSON.parse(e.target.result);
                                this.importTemplates(templates);
                            } catch (error) {
                                this.showNotification('Fehler beim Importieren der Datei', 'error');
                            }
                        };
                        reader.readAsText(file);
                    } else {
                        this.showNotification('Nur JSON-Dateien werden unterstützt', 'error');
                    }
                });
            }
            
            importTemplates(templates) {
                this.showNotification(`${templates.length} Vorlagen werden importiert...`, 'info');
                // In real implementation, this would save templates to backend
                
                setTimeout(() => {
                    this.showNotification('Vorlagen erfolgreich importiert!', 'success');
                    // Refresh template grid
                    this.refreshTemplateGrid();
                }, 2000);
            }
            
            exportTemplates(format = 'json') {
                // Get all template data
                const templates = [
                    this.getTemplateData('1'),
                    this.getTemplateData('2'), 
                    this.getTemplateData('3'),
                    this.getTemplateData('4')
                ].map((template, index) => ({
                    id: String(index + 1),
                    ...template,
                    created_at: new Date().toISOString(),
                    version: '1.0'
                }));
                
                let content, filename, mimeType;
                
                switch (format) {
                    case 'json':
                        content = JSON.stringify({
                            export_info: {
                                version: '1.0',
                                exported_at: new Date().toISOString(),
                                total_templates: templates.length
                            },
                            templates: templates
                        }, null, 2);
                        filename = `anwalts-ai-templates-${new Date().toISOString().split('T')[0]}.json`;
                        mimeType = 'application/json';
                        break;
                        
                    case 'pdf':
                        // Mock PDF export - in real app, would generate actual PDF
                        content = this.generatePDFContent(templates);
                        filename = `anwalts-ai-templates-${new Date().toISOString().split('T')[0]}.pdf`;
                        mimeType = 'application/pdf';
                        break;
                        
                    case 'docx':
                        // Mock DOCX export - in real app, would generate actual DOCX
                        content = this.generateDOCXContent(templates);
                        filename = `anwalts-ai-templates-${new Date().toISOString().split('T')[0]}.docx`;
                        mimeType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                        break;
                        
                    default:
                        content = JSON.stringify(templates, null, 2);
                        filename = `anwalts-ai-templates-${new Date().toISOString().split('T')[0]}.json`;
                        mimeType = 'application/json';
                }
                
                const dataBlob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                this.showNotification(`Vorlagen als ${format.toUpperCase()} erfolgreich exportiert!`, 'success');
            }
            
            generatePDFContent(templates) {
                // Mock PDF content - in real implementation, would use a proper PDF library
                let pdfContent = '%PDF-1.4\nMock PDF Content\n\nAnwaltsAI Templates Export\n\n';
                templates.forEach((template, index) => {
                    pdfContent += `Template ${index + 1}: ${template.name}\n`;
                    pdfContent += `Category: ${template.category}\n`;
                    pdfContent += `Content: ${template.content.substring(0, 100)}...\n\n`;
                });
                return pdfContent;
            }
            
            generateDOCXContent(templates) {
                // Mock DOCX content - in real implementation, would use a proper DOCX library
                let docxContent = 'AnwaltsAI Templates Export\n\n';
                templates.forEach((template, index) => {
                    docxContent += `${index + 1}. ${template.name}\n`;
                    docxContent += `Category: ${template.category}\n`;
                    docxContent += `Content:\n${template.content}\n\n`;
                    docxContent += '---\n\n';
                });
                return docxContent;
            }
            
            animateChart(chart) {
                const bars = chart.querySelectorAll('.chart-bar');
                bars.forEach((bar, index) => {
                    setTimeout(() => {
                        bar.style.transform = 'scaleY(1)';
                    }, index * 200);
                });
            }
            
            copyClauseToClipboard(clauseItem) {
                const clauseText = clauseItem.querySelector('.clause-text')?.textContent;
                if (clauseText) {
                    navigator.clipboard.writeText(clauseText).then(() => {
                        const copyBtn = clauseItem.querySelector('.copy-clause-btn');
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>Kopiert!';
                        
                        setTimeout(() => {
                            copyBtn.innerHTML = originalText;
                        }, 2000);
                        
                        this.showNotification('Klausel in Zwischenablage kopiert!', 'success');
                    });
                }
            }
            
            refreshTemplateGrid() {
                // In real implementation, this would fetch fresh data from backend
                // For now, just trigger re-animation of existing cards
                const templateCards = document.querySelectorAll('.template-card');
                templateCards.forEach((card, index) => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px) scale(0.95)';
                    
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0) scale(1)';
                    }, index * 100);
                });
            }
            
            // Enhanced Modal System
            setupModals() {
                this.setupImportModal();
                this.setupFilterModal();
                this.setupEmailModal();
                this.setupModalOverlay();
            }
            
            setupImportModal() {
                const importBtn = document.getElementById('import-templates-btn');
                const importModal = document.getElementById('import-modal');
                const importClose = document.getElementById('import-modal-close');
                const dropZone = document.getElementById('import-drop-zone');
                const fileInput = document.getElementById('import-file-input');
                
                if (importBtn && importModal) {
                    importBtn.addEventListener('click', () => {
                        this.openModal('import-modal');
                    });
                }
                
                if (importClose) {
                    importClose.addEventListener('click', () => {
                        this.closeModal('import-modal');
                    });
                }
                
                if (dropZone && fileInput) {
                    dropZone.addEventListener('click', () => {
                        fileInput.click();
                    });
                    
                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZone.classList.add('border-purple-500');
                    });
                    
                    dropZone.addEventListener('dragleave', () => {
                        dropZone.classList.remove('border-purple-500');
                    });
                    
                    dropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropZone.classList.remove('border-purple-500');
                        this.handleImportFiles(e.dataTransfer.files);
                    });
                    
                    fileInput.addEventListener('change', (e) => {
                        this.handleImportFiles(e.target.files);
                    });
                }
            }
            
            setupFilterModal() {
                const filterBtn = document.getElementById('filter-templates-btn');
                const filterModal = document.getElementById('filter-modal');
                const filterClose = document.getElementById('filter-modal-close');
                const applyFilters = document.getElementById('apply-filters-btn');
                const clearFilters = document.getElementById('clear-all-filters-btn');
                const searchInput = document.getElementById('template-search-input');
                
                if (filterBtn && filterModal) {
                    filterBtn.addEventListener('click', () => {
                        this.openModal('filter-modal');
                    });
                }
                
                if (filterClose) {
                    filterClose.addEventListener('click', () => {
                        this.closeModal('filter-modal');
                    });
                }
                
                if (applyFilters) {
                    applyFilters.addEventListener('click', () => {
                        this.applyTemplateFilters();
                        this.closeModal('filter-modal');
                    });
                }
                
                if (clearFilters) {
                    clearFilters.addEventListener('click', () => {
                        this.clearTemplateFilters();
                    });
                }
                
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.liveSearchTemplates(e.target.value);
                    });
                }
                
                // Filter option toggles
                const filterOptions = document.querySelectorAll('#filter-modal .filter-option');
                filterOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        option.classList.toggle('active');
                    });
                });
            }
            
            setupEmailModal() {
                const emailModal = document.getElementById('email-modal');
                const emailClose = document.getElementById('email-modal-close');
                const aiResponseBtn = document.getElementById('ai-response-btn');
                const convertDocBtn = document.getElementById('convert-document-btn');
                const scheduleBtn = document.getElementById('schedule-followup-btn');
                
                if (emailClose) {
                    emailClose.addEventListener('click', () => {
                        this.closeModal('email-modal');
                    });
                }
                
                if (aiResponseBtn) {
                    aiResponseBtn.addEventListener('click', () => {
                        this.generateEmailAIResponse();
                    });
                }
                
                if (convertDocBtn) {
                    convertDocBtn.addEventListener('click', () => {
                        this.convertEmailToDocument();
                    });
                }
                
                if (scheduleBtn) {
                    scheduleBtn.addEventListener('click', () => {
                        this.scheduleEmailFollowup();
                    });
                }
            }
            
            setupModalOverlay() {
                const overlay = document.getElementById('modal-overlay');
                if (overlay) {
                    overlay.addEventListener('click', () => {
                        this.closeAllModals();
                    });
                }
            }
            
            // Modal Management
            openModal(modalId) {
                const modal = document.getElementById(modalId);
                const overlay = document.getElementById('modal-overlay');
                
                if (modal && overlay) {
                    // Show overlay
                    overlay.classList.add('active');
                    
                    // Show modal with animation
                    setTimeout(() => {
                        modal.classList.add('active');
                        modal.classList.add('modal-enter');
                        
                        // Remove animation class after completion
                        setTimeout(() => {
                            modal.classList.remove('modal-enter');
                        }, 300);
                    }, 50);
                    
                    // Trap focus
                    this.trapFocus(modal);
                }
            }
            
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                const overlay = document.getElementById('modal-overlay');
                
                if (modal && overlay) {
                    modal.classList.add('modal-exit');
                    
                    setTimeout(() => {
                        modal.classList.remove('active', 'modal-exit');
                        overlay.classList.remove('active');
                    }, 300);
                }
            }
            
            closeAllModals() {
                const modals = document.querySelectorAll('.glassmorphic-modal.active');
                const overlay = document.getElementById('modal-overlay');
                
                modals.forEach(modal => {
                    modal.classList.add('modal-exit');
                    setTimeout(() => {
                        modal.classList.remove('active', 'modal-exit');
                    }, 300);
                });
                
                if (overlay) {
                    overlay.classList.remove('active');
                }
            }
            
            // Enhanced Email Preview (replaces old side panel)
            showEmailPreview(emailId) {
                const emailData = this.getEmailData(emailId);
                this.populateEmailModal(emailData);
                this.openModal('email-modal');
            }
            
            populateEmailModal(emailData) {
                const subject = document.getElementById('email-modal-subject');
                const from = document.getElementById('email-modal-from');
                const date = document.getElementById('email-modal-date');
                const status = document.getElementById('email-modal-status');
                const urgency = document.getElementById('email-modal-urgency');
                const content = document.getElementById('email-modal-content');
                
                if (subject) subject.textContent = emailData.subject;
                if (from) from.textContent = emailData.from;
                if (date) date.textContent = emailData.date;
                if (status) status.textContent = emailData.status;
                if (urgency) urgency.textContent = emailData.urgency;
                if (content) content.innerHTML = emailData.content;
            }
            
            getEmailData(emailId) {
                // Mock email data - in real app, this would fetch from backend
                const mockEmails = {
                    '1': {
                        subject: 'Anfrage Kaufvertrag Immobilie',
                        from: 'client@example.com',
                        date: 'Today, 10:30 AM',
                        status: 'Unread',
                        urgency: 'High Priority',
                        content: `
                            <p>Sehr geehrte Damen und Herren,</p>
                            <p>ich benötige Unterstützung beim <strong>Kauf einer Immobilie</strong> in München. Könnten Sie mir einen Kaufvertrag erstellen?</p>
                            <p>Die wichtigsten Details:</p>
                            <ul>
                                <li>Kaufpreis: €650.000</li>
                                <li>Lage: München-Schwabing</li>
                                <li>Größe: 85 qm, 3 Zimmer</li>
                                <li>Notartermin: nächste Woche</li>
                            </ul>
                            <p>Mit freundlichen Grüßen<br>Max Mustermann</p>
                        `
                    },
                    '2': {
                        subject: 'Mandantenvertretung - Herr Schmidt',
                        from: 'partner@lawfirm.de',
                        date: 'Yesterday, 3:45 PM',
                        status: 'Read',
                        urgency: 'Medium Priority',
                        content: `
                            <p>Liebe Kollegin,</p>
                            <p>bezüglich des Mandats von Herrn Schmidt möchte ich Sie über den aktuellen Stand informieren...</p>
                        `
                    },
                    '3': {
                        subject: 'Vergleichsvorschlag - Sache Weber',
                        from: 'opposing@counsel.de',
                        date: '2 days ago, 11:20 AM',
                        status: 'Unread',
                        urgency: 'High Priority',
                        content: `
                            <p>Sehr geehrte Damen und Herren,</p>
                            <p>in der Sache Weber ./. Mueller möchten wir Ihnen folgenden Vergleichsvorschlag unterbreiten...</p>
                        `
                    }
                };
                
                return mockEmails[emailId] || mockEmails['1'];
            }
            
            // Template Actions
            handleImportFiles(files) {
                Array.from(files).forEach(file => {
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    
                    if (['json', 'pdf', 'docx'].includes(fileExtension)) {
                        this.showNotification(`Importing ${file.name}...`, 'info');
                        // Simulate import process
                        setTimeout(() => {
                            this.showNotification(`${file.name} imported successfully!`, 'success');
                            this.refreshTemplateGrid();
                        }, 2000);
                    } else {
                        this.showNotification(`Unsupported file type: ${fileExtension}`, 'error');
                    }
                });
                
                this.closeModal('import-modal');
            }
            
            applyTemplateFilters() {
                const activeFilters = Array.from(document.querySelectorAll('#filter-modal .filter-option.active'))
                    .map(option => option.dataset.filter);
                
                const searchTerm = document.getElementById('template-search-input')?.value || '';
                
                this.filterTemplates({
                    categories: activeFilters.filter(f => ['contracts', 'payment', 'employment', 'real-estate', 'litigation', 'corporate'].includes(f)),
                    types: activeFilters.filter(f => ['system', 'personal', 'firm', 'custom'].includes(f)),
                    usage: activeFilters.filter(f => ['high-usage', 'medium-usage', 'low-usage', 'unused'].includes(f)),
                    successRate: activeFilters.filter(f => ['excellent', 'good', 'average', 'needs-improvement'].includes(f)),
                    search: searchTerm
                });
                
                this.showNotification(`Filters applied (${activeFilters.length} active)`, 'info');
            }
            
            clearTemplateFilters() {
                const filterOptions = document.querySelectorAll('#filter-modal .filter-option');
                const searchInput = document.getElementById('template-search-input');
                
                filterOptions.forEach(option => option.classList.remove('active'));
                if (searchInput) searchInput.value = '';
                
                this.filterTemplates({});
                this.showNotification('All filters cleared', 'info');
            }
            
            liveSearchTemplates(searchTerm) {
                this.filterTemplates({ search: searchTerm });
            }
            
            generateEmailAIResponse() {
                this.showNotification('Generating AI response...', 'info');
                setTimeout(() => {
                    this.showNotification('AI response generated successfully!', 'success');
                }, 2000);
            }
            
            convertEmailToDocument() {
                this.showNotification('Converting email to document...', 'info');
                setTimeout(() => {
                    this.switchSection('generator');
                    this.closeModal('email-modal');
                    this.showNotification('Email converted to document template!', 'success');
                }, 1500);
            }
            
            scheduleEmailFollowup() {
                this.showNotification('Follow-up scheduled for tomorrow', 'success');
            }
            
            // Keyboard Shortcuts
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // ESC to close modals
                    if (e.key === 'Escape') {
                        this.closeAllModals();
                    }
                    
                    // Ctrl+K to focus filter
                    if (e.ctrlKey && e.key === 'k') {
                        e.preventDefault();
                        this.openModal('filter-modal');
                        setTimeout(() => {
                            document.getElementById('template-search-input')?.focus();
                        }, 350);
                    }
                    
                    // Ctrl+I to trigger import
                    if (e.ctrlKey && e.key === 'i') {
                        e.preventDefault();
                        if (this.currentSection === 'templates') {
                            this.openModal('import-modal');
                        }
                    }
                });
            }
            
            // Focus Management
            trapFocus(modal) {
                const focusableElements = modal.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];
                
                if (firstElement) {
                    firstElement.focus();
                }
                
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        if (e.shiftKey) {
                            if (document.activeElement === firstElement) {
                                e.preventDefault();
                                lastElement.focus();
                            }
                        } else {
                            if (document.activeElement === lastElement) {
                                e.preventDefault();
                                firstElement.focus();
                            }
                        }
                    }
                });
            }
            
            openCreateTemplateModal() {
                // Check if modal already exists
                let modal = document.getElementById('create-template-modal');
                if (!modal) {
                    // Create the modal if it doesn't exist
                    modal = this.createTemplateModal();
                    document.body.appendChild(modal);
                }
                
                // Reset form
                this.resetCreateTemplateForm();
                
                // Show modal
                modal.classList.add('active');
                document.body.classList.add('modal-open');
                
                // Focus on title input
                setTimeout(() => {
                    const titleInput = document.getElementById('create-template-title');
                    if (titleInput) titleInput.focus();
                }, 100);
            }
            
            createTemplateModal() {
                const modal = document.createElement('div');
                modal.id = 'create-template-modal';
                modal.className = 'glassmorphic-modal z-50';
                modal.innerHTML = `
                    <div class="modal-overlay" id="create-modal-overlay"></div>
                    <div class="modal-container max-w-2xl w-full mx-4">
                        <div class="modal-header">
                            <h2 class="text-xl font-semibold text-white">Create New Template</h2>
                            <button class="modal-close" id="create-modal-close" aria-label="Close">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <div class="modal-body space-y-6">
                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Template Title</label>
                                <input type="text" id="create-template-title" class="template-input w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-purple-500 focus:outline-none" placeholder="Enter template title">
                            </div>
                            
                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Description</label>
                                <textarea id="create-template-description" rows="3" class="template-input w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-purple-500 focus:outline-none resize-none" placeholder="Enter template description"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Template Content</label>
                                <textarea id="create-template-content" rows="8" class="template-input w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-purple-500 focus:outline-none resize-y" placeholder="Enter template content with placeholders like {{client_name}}, {{date}}, etc."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Tags</label>
                                <div class="tag-input-container">
                                    <input type="text" id="create-tag-input" class="template-input w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-purple-500 focus:outline-none" placeholder="Add tags (press Enter to add)">
                                    <div id="create-template-tags" class="flex flex-wrap gap-2 mt-3"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="cancel-btn px-4 py-2 bg-gray-600 rounded-lg text-white hover:bg-gray-700 transition-colors" id="create-cancel-btn">
                                Cancel
                            </button>
                            <button class="save-btn px-6 py-2 bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg text-white font-medium hover:from-purple-600 hover:to-blue-700 transition-all disabled:opacity-50" id="create-save-btn" disabled>
                                <span class="btn-text">Create Template</span>
                                <div class="btn-loader hidden">
                                    <div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                </div>
                            </button>
                        </div>
                    </div>
                `;
                
                // Setup event listeners
                this.setupCreateTemplateModalListeners(modal);
                
                return modal;
            }
            
            setupCreateTemplateModalListeners(modal) {
                const overlay = modal.querySelector('#create-modal-overlay');
                const closeBtn = modal.querySelector('#create-modal-close');
                const cancelBtn = modal.querySelector('#create-cancel-btn');
                const saveBtn = modal.querySelector('#create-save-btn');
                const tagInput = modal.querySelector('#create-tag-input');
                
                // Close modal events
                const closeModal = () => {
                    modal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                };
                
                if (overlay) overlay.onclick = closeModal;
                if (closeBtn) closeBtn.onclick = closeModal;
                if (cancelBtn) cancelBtn.onclick = closeModal;
                
                // Save template
                if (saveBtn) {
                    saveBtn.onclick = () => {
                        this.saveNewTemplate();
                        closeModal();
                    };
                }
                
                // Add tags on Enter
                if (tagInput) {
                    tagInput.onkeypress = (e) => {
                        if (e.key === 'Enter' && tagInput.value.trim()) {
                            this.addTagToCreate(tagInput.value.trim());
                            tagInput.value = '';
                        }
                    };
                }
                
                // Track changes to enable/disable save button
                this.setupCreateChangeTracking();
            }
            
            resetCreateTemplateForm() {
                document.getElementById('create-template-title').value = '';
                document.getElementById('create-template-description').value = '';
                document.getElementById('create-template-content').value = '';
                document.getElementById('create-template-tags').innerHTML = '';
                document.getElementById('create-save-btn').disabled = true;
            }
            
            addTagToCreate(tagText) {
                const tagsContainer = document.getElementById('create-template-tags');
                const tag = document.createElement('span');
                tag.className = 'template-tag-editable bg-purple-500/20 text-purple-300 px-3 py-1 rounded-full text-sm flex items-center gap-2';
                tag.innerHTML = `
                    ${tagText}
                    <button class="remove-tag hover:text-red-400" onclick="this.parentElement.remove(); window.dashboard.checkCreateFormChanges();">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                `;
                tagsContainer.appendChild(tag);
                
                // Re-initialize Lucide icons
                if (window.lucide) window.lucide.createIcons();
                
                this.checkCreateFormChanges();
            }
            
            setupCreateChangeTracking() {
                const titleInput = document.getElementById('create-template-title');
                const descInput = document.getElementById('create-template-description');
                const contentInput = document.getElementById('create-template-content');
                
                const checkForChanges = () => {
                    this.checkCreateFormChanges();
                };
                
                if (titleInput) titleInput.addEventListener('input', checkForChanges);
                if (descInput) descInput.addEventListener('input', checkForChanges);
                if (contentInput) contentInput.addEventListener('input', checkForChanges);
            }
            
            checkCreateFormChanges() {
                const title = document.getElementById('create-template-title')?.value.trim();
                const content = document.getElementById('create-template-content')?.value.trim();
                const saveBtn = document.getElementById('create-save-btn');
                
                if (saveBtn) {
                    saveBtn.disabled = !title || !content;
                }
            }
            
            saveNewTemplate() {
                const title = document.getElementById('create-template-title').value.trim();
                const description = document.getElementById('create-template-description').value.trim();
                const content = document.getElementById('create-template-content').value.trim();
                const tags = Array.from(document.querySelectorAll('#create-template-tags .template-tag-editable'))
                    .map(tag => tag.textContent.trim());
                
                // Generate new template ID
                const newTemplateId = String(Date.now());
                
                // Create template data
                const templateData = {
                    title,
                    description: description || 'Custom template',
                    content,
                    tags: tags.length > 0 ? tags : ['Custom'],
                    category: 'custom',
                    version: 1.0,
                    created: new Date().toISOString(),
                    author: 'User'
                };
                
                // Add to template grid (this would normally save to backend)
                this.addNewTemplateToGrid(newTemplateId, templateData);
                
                this.showNotification(`Template "${title}" created successfully!`, 'success');
            }
            
            addNewTemplateToGrid(templateId, templateData) {
                const grid = document.getElementById('template-grid');
                if (!grid) return;
                
                // Create new template card HTML
                const cardHtml = this.generateTemplateCardHtml(templateId, templateData);
                grid.insertAdjacentHTML('beforeend', cardHtml);
                
                // Re-initialize Lucide icons
                if (window.lucide) {
                    window.lucide.createIcons();
                }
                
                // Setup event listeners for the new card
                this.setupNewTemplateCardListeners(templateId);
            }
            
            generateTemplateCardHtml(templateId, templateData) {
                const tagsHtml = this.generateTagsHtml(templateData.tags || []);
                
                return `
                    <div class="template-card" style="--animation-delay: 0.1s; animation-delay: 0.1s" data-template-id="${templateId}" data-testid="template-card-${templateId}">
                        <div class="template-border-glow"></div>
                        <div class="relative z-10">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <h3 class="template-title text-lg font-semibold text-white mb-2">${templateData.title}</h3>
                                    <p class="template-description text-sm text-gray-400 serif-text">${templateData.description}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="success-rate-badge text-xs px-2 py-1 bg-green-500/20 text-green-400 rounded-full">
                                        New
                                    </span>
                                    <button class="p-2 hover:bg-white/10 rounded-lg transition-colors edit-template-btn" title="Edit Template" data-template-id="${templateId}">
                                        <i data-lucide="edit-2" class="w-4 h-4 text-gray-400"></i>
                                    </button>
                                    <button class="p-2 hover:bg-white/10 rounded-lg transition-colors" title="More Options">
                                        <i data-lucide="more-vertical" class="w-4 h-4 text-gray-400"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex flex-wrap gap-2 mb-4">
                                ${tagsHtml}
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                                <div>
                                    <span class="text-gray-400">Created by:</span>
                                    <p class="text-white font-medium">${templateData.author}</p>
                                </div>
                                <div>
                                    <span class="text-gray-400">Created:</span>
                                    <p class="text-white font-medium">Just now</p>
                                </div>
                                <div>
                                    <span class="text-gray-400">Usage count:</span>
                                    <p class="text-white font-medium">0 times</p>
                                </div>
                                <div>
                                    <span class="text-gray-400">Status:</span>
                                    <p class="text-blue-400 font-medium">Ready</p>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <button class="use-template-btn flex-1 py-2 bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg text-white font-medium hover:from-purple-600 hover:to-blue-700 transition-all" 
                                        data-template-id="${templateId}" 
                                        data-testid="use-template-${templateId}">
                                    Use Template
                                </button>
                                <button class="copy-template-btn p-2 bg-gray-600 rounded-lg text-white hover:bg-gray-700 transition-colors" 
                                        title="Copy to Clipboard" 
                                        data-template-id="${templateId}"
                                        data-testid="copy-template-${templateId}">
                                    <i data-lucide="copy" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            generateTagsHtml(tags) {
                if (!tags || tags.length === 0) return '';
                
                return tags.map(tag => 
                    `<span class="template-tag ${tag.toLowerCase()}">${tag}</span>`
                ).join('');
            }
            
            setupNewTemplateCardListeners(templateId) {
                const card = document.querySelector(`[data-template-id="${templateId}"]`);
                if (!card) return;
                
                const useBtn = card.querySelector('.use-template-btn');
                const copyBtn = card.querySelector('.copy-template-btn');
                const editBtn = card.querySelector('.edit-template-btn');
                
                if (useBtn) {
                    useBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.useTemplate(templateId);
                    });
                }
                
                if (copyBtn) {
                    copyBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.copyTemplateToClipboard(templateId);
                    });
                }
                
                if (editBtn) {
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.editTemplate(templateId);
                    });
                }
            }
            
            copyTemplateToClipboard(templateId) {
                // Get template data
                const templateData = this.getTemplateData(templateId);
                if (!templateData) {
                    this.showNotification('Template not found', 'error');
                    return;
                }
                
                // Create clipboard content
                const clipboardContent = {
                    id: templateId,
                    title: templateData.name || templateData.title,
                    content: templateData.content,
                    category: templateData.category,
                    type: 'anwalts-template',
                    exportedAt: new Date().toISOString()
                };
                
                // Copy to clipboard
                const textContent = JSON.stringify(clipboardContent, null, 2);
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(textContent).then(() => {
                        this.showNotification('Template copied to clipboard!', 'success');
                        this.showCopyFeedback(templateId);
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                        this.fallbackCopyToClipboard(textContent, templateId);
                    });
                } else {
                    // Fallback for older browsers or non-HTTPS
                    this.fallbackCopyToClipboard(textContent, templateId);
                }
            }
            
            fallbackCopyToClipboard(text, templateId) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    textArea.remove();
                    this.showNotification('Template copied to clipboard!', 'success');
                    this.showCopyFeedback(templateId);
                } catch (err) {
                    console.error('Fallback copy failed: ', err);
                    textArea.remove();
                    this.showNotification('Failed to copy template', 'error');
                }
            }
            
            showCopyFeedback(templateId) {
                const copyBtn = document.querySelector(`[data-template-id="${templateId}"] .copy-template-btn`);
                if (!copyBtn) return;
                
                // Show visual feedback
                const originalIcon = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
                copyBtn.classList.add('bg-green-600');
                copyBtn.classList.remove('bg-gray-600');
                
                // Reset after 2 seconds
                setTimeout(() => {
                    copyBtn.innerHTML = originalIcon;
                    copyBtn.classList.remove('bg-green-600');
                    copyBtn.classList.add('bg-gray-600');
                    
                    // Re-initialize lucide icons
                    if (window.lucide) window.lucide.createIcons();
                }, 2000);
            }

            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium shadow-lg transform transition-all duration-300 translate-x-full`;
                
                // Set notification style based on type
                if (type === 'success') {
                    notification.className += ' bg-green-500';
                } else if (type === 'error') {
                    notification.className += ' bg-red-500';
                } else {
                    notification.className += ' bg-blue-500';
                }
                
                notification.textContent = message;
                
                // Add to document
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 100);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        }

        // Global navigation function
        function switchSection(section) {
            if (window.dashboard) {
                window.dashboard.switchSection(section);
            }
        }

        // Sign out functionality
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                // Clear any stored user data
                localStorage.clear();
                sessionStorage.clear();
                
                // Show sign out message
                alert('You have been signed out successfully.');
                
                // Redirect to landing page
                window.location.href = 'anwalts-ai-app.html';
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new AnwaltsAIDashboard();
            
            // Setup sign out button
            const signOutBtn = document.getElementById('signout-btn');
            if (signOutBtn) {
                signOutBtn.addEventListener('click', signOut);
            }
        });
    </script>
    
    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modal-overlay"></div>
    
    <!-- Email Preview Modal -->
    <div class="glassmorphic-modal email-modal" id="email-modal">
        <button class="modal-close" id="email-modal-close" aria-label="Close email preview">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
        
        <div class="modal-body">
            <!-- Email Metadata -->
            <div class="email-metadata">
                <h3 class="text-lg font-semibold text-white mb-3" id="email-modal-subject">Email Subject</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-400">From:</span>
                        <p class="text-white font-medium" id="email-modal-from">sender@example.com</p>
                    </div>
                    <div>
                        <span class="text-gray-400">Date:</span>
                        <p class="text-white font-medium" id="email-modal-date">Today, 10:30 AM</p>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-gray-400">Status:</span>
                    <span class="ml-2 px-2 py-1 bg-blue-500/20 text-blue-400 rounded-full text-xs" id="email-modal-status">Unread</span>
                    <span class="ml-2 px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded-full text-xs" id="email-modal-urgency">Medium Priority</span>
                </div>
            </div>
            
            <!-- Email Content -->
            <div class="email-content-panel">
                <div class="prose prose-invert max-w-none" id="email-modal-content">
                    <p>Email content will be loaded here...</p>
                </div>
            </div>
            
            <!-- Email Actions -->
            <div class="email-actions">
                <button class="action-btn primary" id="ai-response-btn">
                    <i data-lucide="brain" class="w-4 h-4"></i>
                    Generate AI Response
                </button>
                <button class="action-btn secondary" id="convert-document-btn">
                    <i data-lucide="file-plus" class="w-4 h-4"></i>
                    Convert to Document
                </button>
                <button class="action-btn danger" id="schedule-followup-btn">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    Schedule Follow-up
                </button>
            </div>
        </div>
    </div>
    
    <!-- Template Filter Modal -->
    <div class="glassmorphic-modal filter-modal" id="filter-modal">
        <button class="modal-close" id="filter-modal-close" aria-label="Close filter">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
        
        <div class="modal-header">
            <h3 class="text-lg font-semibold text-white">Filter Templates</h3>
        </div>
        
        <div class="modal-body">
            <!-- Search -->
            <div class="filter-section">
                <h4>Search Templates</h4>
                <input type="text" class="search-input" placeholder="Search by name, content, or creator..." id="template-search-input">
            </div>
            
            <!-- Category Filter -->
            <div class="filter-section">
                <h4>Category</h4>
                <div class="filter-options">
                    <span class="filter-option" data-filter="contracts">Contracts</span>
                    <span class="filter-option" data-filter="payment">Payment</span>
                    <span class="filter-option" data-filter="employment">Employment</span>
                    <span class="filter-option" data-filter="real-estate">Real Estate</span>
                    <span class="filter-option" data-filter="litigation">Litigation</span>
                    <span class="filter-option" data-filter="corporate">Corporate</span>
                </div>
            </div>
            
            <!-- Type Filter -->
            <div class="filter-section">
                <h4>Template Type</h4>
                <div class="filter-options">
                    <span class="filter-option" data-filter="system">System</span>
                    <span class="filter-option" data-filter="personal">Personal</span>
                    <span class="filter-option" data-filter="firm">Firm</span>
                    <span class="filter-option" data-filter="custom">Custom</span>
                </div>
            </div>
            
            <!-- Usage Filter -->
            <div class="filter-section">
                <h4>Usage Count</h4>
                <div class="filter-options">
                    <span class="filter-option" data-filter="high-usage">High Usage (50+)</span>
                    <span class="filter-option" data-filter="medium-usage">Medium Usage (10-49)</span>
                    <span class="filter-option" data-filter="low-usage">Low Usage (1-9)</span>
                    <span class="filter-option" data-filter="unused">Unused (0)</span>
                </div>
            </div>
            
            <!-- Success Rate Filter -->
            <div class="filter-section">
                <h4>Success Rate</h4>
                <div class="filter-options">
                    <span class="filter-option" data-filter="excellent">Excellent (90%+)</span>
                    <span class="filter-option" data-filter="good">Good (75-89%)</span>
                    <span class="filter-option" data-filter="average">Average (60-74%)</span>
                    <span class="filter-option" data-filter="needs-improvement">Needs Improvement (<60%)</span>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-3 mt-6 pt-4 border-t border-white/10">
                <button class="action-btn secondary" id="apply-filters-btn">
                    <i data-lucide="check" class="w-4 h-4"></i>
                    Apply Filters
                </button>
                <button class="action-btn danger" id="clear-all-filters-btn">
                    <i data-lucide="x" class="w-4 h-4"></i>
                    Clear All
                </button>
            </div>
        </div>
    </div>
    
    <!-- Template Import Modal -->
    <div class="glassmorphic-modal" id="import-modal" style="width: 500px; height: 400px;">
        <button class="modal-close" id="import-modal-close" aria-label="Close import">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
        
        <div class="modal-header">
            <h3 class="text-lg font-semibold text-white">Import Templates</h3>
        </div>
        
        <div class="modal-body">
            <div class="text-center py-8">
                <div class="border-2 border-dashed border-gray-500 rounded-lg p-8 hover:border-purple-500 transition-colors cursor-pointer" id="import-drop-zone">
                    <i data-lucide="upload" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                    <p class="text-white font-medium mb-2">Drop files here or click to browse</p>
                    <p class="text-gray-400 text-sm">Supports PDF, DOCX, and JSON files</p>
                    <input type="file" class="hidden" id="import-file-input" multiple accept=".pdf,.docx,.json">
                </div>
            </div>
            
            <div class="mt-6">
                <div class="flex items-center gap-2 text-sm text-gray-400 mb-2">
                    <i data-lucide="info" class="w-4 h-4"></i>
                    Supported formats:
                </div>
                <ul class="text-sm text-gray-300 space-y-1 ml-6">
                    <li>• <strong>JSON:</strong> Exported template collections</li>
                    <li>• <strong>PDF:</strong> Existing documents to convert</li>
                    <li>• <strong>DOCX:</strong> Word documents to import</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>